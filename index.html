<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMCAM Dashboard v4.7 - Rectangular Status Boxes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- jsPDF for Invoice Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Remove number input arrows */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Make calendar popups 2x larger */
        input[type="date"]::-webkit-calendar-picker-indicator {
            font-size: 2em;
            cursor: pointer;
        }
        
        /* Chrome/Edge calendar popup styling */
        input[type="date"]::-webkit-datetime-edit {
            padding: 0.5em;
        }
        
        /* Make the calendar dropdown itself larger in supported browsers */
        @media screen and (-webkit-min-device-pixel-ratio:0) {
            input[type="date"] {
                min-height: 2.5em;
            }
        }
        
        /* Ensure editable text inherits color from row */
        tbody tr td > div {
            color: inherit;
        }
        
        /* Smooth, slow, elegant slide down animation */
        @keyframes slideDown {
            0% {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
                max-height: 0;
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
                max-height: 600px;
            }
        }
        
        /* Fade in animation for individual buttons */
        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: translateY(-10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fadeIn 1s ease-out forwards;
            opacity: 0;
        }
        
        /* Row expansion with ultra-smooth, luxurious 2-second transitions */
        tbody tr {
            transition: all 2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Expanded row styling */
        tbody tr.calendar-expanded {
            background: linear-gradient(to right, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.04)) !important;
            box-shadow: inset 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        
        tbody tr.calendar-expanded td {
            padding-top: 2rem !important;
            padding-bottom: 2rem !important;
            vertical-align: top !important;
            transition: padding 2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Make cells take full width when expanded */
        tbody tr.calendar-expanded td > div {
            width: 100%;
        }
        
        /* Ultra-smooth 2-second chevron rotation with bounce */
        .chevron-rotate {
            transition: transform 2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // Lucide Icons as inline SVG components
        const ChevronDown = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m6 9 6 6 6-6"/></svg>;
        const ChevronRight = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m9 18 6-6-6-6"/></svg>;
        const Plus = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        const MoreHorizontal = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>;
        const GripVertical = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>;
        const Trash2 = ({ size = 18 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
        const Save = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const Upload = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
        const Settings = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const X = ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
        const Calendar = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
        const User = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const Bell = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>;
        const Download = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
        const RefreshCw = ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>;
        const BarChart = ({ size = 18 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>;
        const Eye = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>;
        const EyeOff = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>;
        const Lock = ({ size = 64 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;

        // ========== INLINE EXPANDING CALENDAR COMPONENT ==========
        const InlineCalendar = ({ value, onChange, darkMode, onToggle, isExpanded }) => {
            const [currentMonth, setCurrentMonth] = useState(new Date(value || new Date()));

            const formatDisplayDate = (dateStr) => {
                if (!dateStr) return 'Select date';
                const date = new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            };

            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();
                
                const days = [];
                for (let i = 0; i < startingDayOfWeek; i++) {
                    days.push(null);
                }
                for (let i = 1; i <= daysInMonth; i++) {
                    days.push(i);
                }
                return days;
            };

            const handleDayClick = (day) => {
                if (day) {
                    const year = currentMonth.getFullYear();
                    const month = currentMonth.getMonth();
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    onChange(dateStr);
                    onToggle();
                }
            };

            const changeMonth = (delta) => {
                setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + delta, 1));
            };

            const days = getDaysInMonth(currentMonth);
            const monthName = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const selectedDate = value ? new Date(value + 'T00:00:00') : null;

            return (
                <div className="w-full">
                    <button
                        type="button"
                        onClick={onToggle}
                        className="border rounded px-3 py-2 text-sm hover:border-blue-400 focus:outline-none focus:border-blue-500 w-full text-left flex items-center justify-between"
                        style={{
                            borderColor: isExpanded ? '#3b82f6' : (darkMode ? '#4a4a4a' : '#e5e7eb'),
                            backgroundColor: darkMode ? '#3a3a3a' : '#ffffff',
                            color: darkMode ? '#ffffff' : '#000000',
                            fontSize: '14px',
                            minHeight: '38px',
                            boxShadow: isExpanded ? '0 0 0 3px rgba(59, 130, 246, 0.2)' : 'none',
                            transition: 'all 2s ease'
                        }}
                    >
                        <span className="font-medium">{formatDisplayDate(value)}</span>
                        <div className="chevron-rotate" style={{ transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)' }}>
                            <ChevronDown />
                        </div>
                    </button>

                    {isExpanded && (
                        <div 
                            className="mt-3 rounded-lg shadow-xl border-2"
                            style={{
                                backgroundColor: darkMode ? '#2a2a2a' : '#ffffff',
                                borderColor: '#3b82f6',
                                padding: '16px',
                                width: '360px',
                                animation: 'slideDown 2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards'
                            }}
                        >
                            <div className="flex items-center justify-between mb-4">
                                <button
                                    type="button"
                                    onClick={() => changeMonth(-1)}
                                    className="p-2 rounded-lg hover:scale-110 transition-transform font-bold text-xl"
                                    style={{
                                        backgroundColor: darkMode ? '#3a3a3a' : '#f3f4f6',
                                        color: darkMode ? '#ffffff' : '#000000'
                                    }}
                                >
                                    â€¹
                                </button>
                                <span className="font-bold text-lg" style={{ color: darkMode ? '#ffffff' : '#000000' }}>
                                    {monthName}
                                </span>
                                <button
                                    type="button"
                                    onClick={() => changeMonth(1)}
                                    className="p-2 rounded-lg hover:scale-110 transition-transform font-bold text-xl"
                                    style={{
                                        backgroundColor: darkMode ? '#3a3a3a' : '#f3f4f6',
                                        color: darkMode ? '#ffffff' : '#000000'
                                    }}
                                >
                                    â€º
                                </button>
                            </div>

                            <div className="grid grid-cols-7 gap-1 mb-2">
                                {['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].map(day => (
                                    <div key={day} className="text-center font-bold text-xs" style={{ color: darkMode ? '#9ca3af' : '#6b7280' }}>
                                        {day}
                                    </div>
                                ))}
                            </div>

                            <div className="grid grid-cols-7 gap-1">
                                {days.map((day, idx) => {
                                    if (!day) {
                                        return <div key={idx} />;
                                    }
                                    
                                    const isSelected = selectedDate && 
                                        selectedDate.getDate() === day &&
                                        selectedDate.getMonth() === currentMonth.getMonth() &&
                                        selectedDate.getFullYear() === currentMonth.getFullYear();

                                    return (
                                        <button
                                            key={idx}
                                            type="button"
                                            onClick={() => handleDayClick(day)}
                                            className="rounded-lg text-sm font-semibold transition-all duration-2000 hover:scale-110 hover:shadow-md"
                                            style={{
                                                padding: '8px',
                                                backgroundColor: isSelected 
                                                    ? '#3b82f6' 
                                                    : darkMode ? '#3a3a3a' : '#f9fafb',
                                                color: isSelected ? '#ffffff' : darkMode ? '#ffffff' : '#000000',
                                                border: isSelected ? '2px solid #2563eb' : '1px solid ' + (darkMode ? '#4a4a4a' : '#e5e7eb')
                                            }}
                                        >
                                            {day}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // API Configuration (deprecated - keeping for reference)
        const API_URL = 'http://localhost:3001';

        // ========== FIREBASE CONFIGURATION ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDSLjUPp5hBkGDQnrIGL4iWDUNJC-YVXoY",
            authDomain: "comcam-dashboard.firebaseapp.com",
            databaseURL: "https://comcam-dashboard-default-rtdb.firebaseio.com",
            projectId: "comcam-dashboard",
            storageBucket: "comcam-dashboard.firebasestorage.app",
            messagingSenderId: "102412134495",
            appId: "1:102412134495:web:dc80978df11e1c569093ea"
        };

        // Initialize Firebase
        let database;
        let auth;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            console.log('âœ… Firebase initialized successfully');
        } catch (error) {
            console.error('âŒ Firebase initialization error:', error);
        }

        // ========== COLOR CONTRAST HELPER ==========
        // Function to determine if text should be white or dark based on background color
        const getTextColor = (bgColor) => {
            // Remove # if present
            const hex = bgColor.replace('#', '');
            
            // Convert to RGB
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            
            // Calculate relative luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            // Return white for dark backgrounds, dark for light backgrounds
            return luminance > 0.5 ? '#1f2937' : '#ffffff';
        };

        // ========== COLOR THEMES ==========
        const colorThemes = {
            'None': {
                name: 'None',
                background: '#ffffff',   // White
                cardBg: '#ffffff',       // White cards
                primary: '#A4243B',      // Deep red/burgundy
                secondary: '#D8C99B',    // Tan/beige
                accent: '#D8973C',       // Orange
                highlight: '#BD632F',    // Burnt orange
                dark: '#273E47',         // Dark blue-gray
                textPrimary: '#1f2937',  // Dark text for light mode
                textSecondary: '#6b7280' // Gray text for light mode
            },
            'Cherry Blossom': {
                name: 'Cherry Blossom',
                background: '#FFF5F7',   // Light pink
                cardBg: '#ffffff',       // White cards
                primary: '#A4243B',      // Deep red/burgundy
                secondary: '#D8C99B',    // Tan/beige
                accent: '#D8973C',       // Orange
                highlight: '#BD632F',    // Burnt orange
                dark: '#273E47',         // Dark blue-gray
                textPrimary: '#1f2937',
                textSecondary: '#6b7280'
            },
            'Ocean Bliss': {
                name: 'Ocean Bliss',
                background: '#FFFDF7',   // Cream/off-white
                cardBg: '#FFFDF7',       // Cream cards
                primary: '#0A2342',      // Dark navy
                secondary: '#2CA58D',    // Teal/turquoise
                accent: '#84BC9C',       // Sage green
                highlight: '#F46197',    // Pink
                dark: '#0A2342',         // Dark navy
                textPrimary: '#1f2937',
                textSecondary: '#6b7280'
            },
            'Lavender Dream': {
                name: 'Lavender Dream',
                background: '#F8F7FF',   // Very light lavender
                cardBg: '#ffffff',       // White cards
                primary: '#6B5B95',      // Purple
                secondary: '#B8A9C9',    // Light purple
                accent: '#88B0D3',       // Sky blue
                highlight: '#E8B4B8',    // Dusty rose
                dark: '#4A4063',         // Dark purple
                textPrimary: '#1f2937',
                textSecondary: '#6b7280'
            },
            'Sunset Glow': {
                name: 'Sunset Glow',
                background: '#FFF8F3',   // Very light peach
                cardBg: '#ffffff',       // White cards
                primary: '#FF6B6B',      // Coral red
                secondary: '#FFB84D',    // Golden yellow
                accent: '#FF8E53',       // Orange
                highlight: '#A8E6CF',    // Mint green
                dark: '#4A4A4A',         // Charcoal
                textPrimary: '#1f2937',
                textSecondary: '#6b7280'
            },
            'Forest Mist': {
                name: 'Forest Mist',
                background: '#F5F9F6',   // Very light mint
                cardBg: '#ffffff',       // White cards
                primary: '#2D5F3F',      // Forest green
                secondary: '#6B9080',    // Sage
                accent: '#A4C3A2',       // Light sage
                highlight: '#EAE7DC',    // Warm beige
                dark: '#1B3A2C',         // Dark forest
                textPrimary: '#1f2937',
                textSecondary: '#6b7280'
            },
            'Bubblegum Fantasy': {
                name: 'Bubblegum Fantasy',
                background: '#F0F6F6',   // Light blue-gray
                cardBg: '#ffffff',       // White cards
                primary: '#084B83',      // Deep blue
                secondary: '#42BFDD',    // Bright cyan
                accent: '#BBE6E4',       // Pale cyan
                highlight: '#FF66B3',    // Hot pink
                dark: '#084B83',         // Deep blue
                textPrimary: '#1f2937',
                textSecondary: '#6b7280'
            },
            'Deep Sea Adventure': {
                name: 'Deep Sea Adventure',
                background: '#E8F4F8',   // Very light blue
                cardBg: '#ffffff',       // White cards
                primary: '#173753',      // Dark navy
                secondary: '#6DAEDB',    // Light blue
                accent: '#2892D7',       // Bright blue
                highlight: '#1B4353',    // Teal-gray
                dark: '#173753',         // Dark navy
                textPrimary: '#1f2937',
                textSecondary: '#6b7280'
            },
            'Fresh Forest Foliage': {
                name: 'Fresh Forest Foliage',
                background: '#F5FAF7',   // Very light mint
                cardBg: '#ffffff',       // White cards
                primary: '#283F3B',      // Dark teal-gray
                secondary: '#99DDC8',    // Mint green
                accent: '#95BF74',       // Light olive
                highlight: '#6B8E23',    // Olive Drab green (darker for better contrast)
                dark: '#283F3B',         // Dark teal-gray
                textPrimary: '#1f2937',
                textSecondary: '#6b7280'
            },
            'Golden Spice': {
                name: 'Golden Spice',
                background: '#FFF9F0',   // Cream
                cardBg: '#ffffff',       // White cards
                primary: '#45050C',      // Deep maroon
                secondary: '#EECF6D',    // Soft yellow
                accent: '#D5AC4E',       // Gold
                highlight: '#8B6220',    // Bronze
                dark: '#45050C',         // Deep maroon
                textPrimary: '#1f2937',
                textSecondary: '#6b7280'
            },
            'Tropical Fusion': {
                name: 'Tropical Fusion',
                background: '#FFFBF5',   // Cream white
                cardBg: '#ffffff',       // White cards
                primary: '#392F5A',      // Deep purple
                secondary: '#FF8811',    // Bright orange
                accent: '#F4D06F',       // Soft yellow
                highlight: '#9DD9D2',    // Turquoise
                dark: '#392F5A',         // Deep purple
                textPrimary: '#1f2937',
                textSecondary: '#6b7280'
            }
        };

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState('');
            const [firebaseSynced, setFirebaseSynced] = useState(false);
            const [initialLoadComplete, setInitialLoadComplete] = useState(false);
            
            const [draggedTask, setDraggedTask] = useState(null);
            const [dragOverTask, setDragOverTask] = useState(null);
            const [deleteConfirm, setDeleteConfirm] = useState(null);
            const [draggedColumn, setDraggedColumn] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [showNewRequests, setShowNewRequests] = useState(false);
            const [newRequests, setNewRequests] = useState([]);
            const [unreadCount, setUnreadCount] = useState(0);
            const [isLoadingRequests, setIsLoadingRequests] = useState(false);
            const [apiConnected, setApiConnected] = useState(false);
            const [selectedTaskForMetrics, setSelectedTaskForMetrics] = useState(null);
            const [showCustomThemeCreator, setShowCustomThemeCreator] = useState(false);
            const [customThemeNames, setCustomThemeNames] = useState([]);
            const [expandedDropdown, setExpandedDropdown] = useState(null); // Track which dropdown/calendar is expanded
            const [customTheme, setCustomTheme] = useState({
                name: '',
                background: '#ffffff',
                cardBg: '#ffffff',
                primary: '#3b82f6',
                secondary: '#8b5cf6',
                accent: '#10b981',
                highlight: '#f59e0b',
                dark: '#1f2937',
                textPrimary: '#1f2937',
                textSecondary: '#6b7280'
            });
            const fileInputRef = useRef(null);
            
            const initialWidths = {
                task: 250,
                clientName: 180,
                person: 180,
                status: 150,
                priority: 120,
                clientType: 220,
                requestDate: 150,
                dueDate: 150,
                actualWorkHours: 120,
                workHours: 120,
                notes: 250,
                invoiceNumber: 150,
                totalPrice: 150,
                timeline: 120,
                invoice: 120,
                metrics: 100,
                drag: 50,
                actions: 80
            };

            const initialTasks = [
                {
                    id: 1,
                    group: 'group1',
                    task: 'Design new landing page',
                    clientName: 'Acme Corp',
                    person: 'Sarah Johnson',
                    status: 'Working on it',
                    priority: 'High',
                    clientType: 'Commercial/Local Business',
                    requestDate: '2025-10-20',
                    dueDate: '2025-10-30',
                    actualWorkHours: '10',
                    workHours: '8',
                    notes: 'Need to review with marketing team',
                    invoiceNumber: 'INV-1001',
                    totalPrice: '2500',
                    timeline: '3 days'
                },
                {
                    id: 2,
                    group: 'group1',
                    task: 'Review marketing materials',
                    clientName: 'TechStart Inc',
                    person: 'Mike Chen',
                    status: 'Done',
                    priority: 'Standard',
                    clientType: 'Out of State Commercial (+30%)',
                    requestDate: '2025-10-18',
                    dueDate: '2025-10-28',
                    actualWorkHours: '5',
                    workHours: '4',
                    notes: 'All materials approved',
                    invoiceNumber: 'INV-1002',
                    totalPrice: '1200',
                    timeline: '2 days'
                },
                {
                    id: 3,
                    group: 'group1',
                    task: 'Update documentation',
                    clientName: 'Global Media',
                    person: 'Emma Wilson',
                    status: 'Stuck',
                    priority: 'Standard',
                    clientType: 'State Government (+20%)',
                    requestDate: '2025-10-22',
                    dueDate: '2025-11-05',
                    actualWorkHours: '14',
                    workHours: '12',
                    notes: 'Waiting for technical specs',
                    invoiceNumber: 'INV-1003',
                    totalPrice: '3200',
                    timeline: '5 days'
                },
                {
                    id: 4,
                    group: 'group2',
                    task: 'Client presentation prep',
                    clientName: 'Innovation Labs',
                    person: 'David Lee',
                    status: 'Working on it',
                    priority: 'High',
                    clientType: 'Federal Government (+50%)',
                    requestDate: '2025-10-19',
                    dueDate: '2025-10-27',
                    actualWorkHours: '7',
                    workHours: '6',
                    notes: 'Slides ready for review',
                    invoiceNumber: 'INV-1004',
                    totalPrice: '1800',
                    timeline: '1 day'
                },
                {
                    id: 5,
                    group: 'group2',
                    task: 'Database optimization',
                    clientName: 'DataFlow Systems',
                    person: 'Sarah Johnson',
                    status: 'Not started',
                    priority: 'Standard',
                    clientType: 'Fortune 500 (x2)',
                    requestDate: '2025-10-23',
                    dueDate: '2025-11-10',
                    actualWorkHours: '20',
                    workHours: '16',
                    notes: 'Need to schedule downtime window',
                    invoiceNumber: 'INV-1005',
                    totalPrice: '4500',
                    timeline: '7 days'
                }
            ];

            // Load data from localStorage or use defaults
            const loadFromStorage = (key, defaultValue) => {
                try {
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : defaultValue;
                } catch (error) {
                    console.error(`Error loading ${key} from localStorage:`, error);
                    return defaultValue;
                }
            };

            // Migration function to add clientType and invoice to existing data
            const migrateData = () => {
                try {
                    // Migrate column order
                    const savedOrder = localStorage.getItem('comcam_columnOrder_v2');
                    if (savedOrder) {
                        const order = JSON.parse(savedOrder);
                        
                        // Add clientType if missing
                        if (!order.includes('clientType')) {
                            const priorityIndex = order.indexOf('priority');
                            if (priorityIndex !== -1) {
                                order.splice(priorityIndex + 1, 0, 'clientType');
                            }
                        }
                        
                        // Add invoice if missing
                        if (!order.includes('invoice')) {
                            const timelineIndex = order.indexOf('timeline');
                            const metricsIndex = order.indexOf('metrics');
                            if (timelineIndex !== -1) {
                                order.splice(timelineIndex + 1, 0, 'invoice');
                            } else if (metricsIndex !== -1) {
                                order.splice(metricsIndex, 0, 'invoice');
                            }
                        }
                        
                        localStorage.setItem('comcam_columnOrder_v2', JSON.stringify(order));
                    }
                    
                    // Migrate column widths
                    const savedWidths = localStorage.getItem('comcam_columnWidths_v2');
                    if (savedWidths) {
                        const widths = JSON.parse(savedWidths);
                        if (!widths.clientType) {
                            widths.clientType = 220;
                        }
                        if (!widths.invoice) {
                            widths.invoice = 120;
                        }
                        if (!widths.drag) {
                            widths.drag = 50;
                        }
                        localStorage.setItem('comcam_columnWidths_v2', JSON.stringify(widths));
                    }
                    
                    // Migrate tasks to add clientType if missing
                    const savedTasks = localStorage.getItem('comcam_tasks');
                    if (savedTasks) {
                        const tasks = JSON.parse(savedTasks);
                        let updated = false;
                        tasks.forEach(task => {
                            if (!task.clientType) {
                                task.clientType = 'Commercial/Local Business';
                                updated = true;
                            }
                        });
                        if (updated) {
                            localStorage.setItem('comcam_tasks', JSON.stringify(tasks));
                        }
                    }
                } catch (error) {
                    console.error('Error during data migration:', error);
                }
            };
            
            // Run migration before loading state
            migrateData();

            const [tasks, setTasks] = useState(() => loadFromStorage('comcam_tasks', initialTasks));
            const [columnWidths, setColumnWidths] = useState(() => loadFromStorage('comcam_columnWidths_v2', initialWidths));
            const [columnOrder, setColumnOrder] = useState(() => loadFromStorage('comcam_columnOrder_v2', [
                'task', 'clientName', 'person', 'status', 'priority', 'clientType', 'requestDate', 'dueDate', 
                'actualWorkHours', 'workHours', 'notes', 'invoiceNumber', 'totalPrice', 'timeline', 'invoice', 'metrics', 'drag', 'actions'
            ]));
            const [expandedGroups, setExpandedGroups] = useState(() => loadFromStorage('comcam_expandedGroups', { group1: true, group2: true }));
            const [settings, setSettings] = useState(() => loadFromStorage('comcam_settings', { 
                dueDateWarning: true,
                autoRefresh: true,
                useTheme: false,
                colorTheme: 'None',
                darkMode: false
            }));
            const [showDashboardTotal, setShowDashboardTotal] = useState(false);
            
            const [resizingColumn, setResizingColumn] = useState(null);
            const resizeStartX = useRef(0);
            const resizeStartWidth = useRef(0);

            const statusColors = {
                'Working on it': '#81b6e3',
                'Done': '#53df98',
                'Stuck': '#e4732f',
                'Not started': '#9ca3af'
            };

            const priorityColors = {
                'High': '#a6e42f',
                'Standard': '#81b6e3'
            };

            const clientTypeColors = {
                'Commercial/Local Business': '#81b6e3',
                'Out of State Commercial (+30%)': '#a6e42f',
                'State Government (+20%)': '#d8973c',
                'Federal Government (+50%)': '#bd632f',
                'Fortune 500 (x2)': '#a4243b',
                'Education (Discount)': '#9370db',
                'Military/Veteran (-40%)': '#53df98'
            };

            // Get current theme colors
            const baseTheme = settings.useTheme 
                ? (colorThemes[settings.colorTheme] || colorThemes['None'])
                : colorThemes['None'];
            
            // Apply dark mode overlay if enabled
            const theme = settings.darkMode ? {
                ...baseTheme,
                background: '#2e2e2e',
                cardBg: '#2e2e2e',
                textPrimary: '#f9fafb',
                textSecondary: '#d1d5db'
            } : baseTheme;

            const toggleGroup = (groupId) => {
                setExpandedGroups(prev => ({
                    ...prev,
                    [groupId]: !prev[groupId]
                }));
            };

            const updateTask = (id, field, value) => {
                setTasks(prev => prev.map(task => {
                    if (task.id === id) {
                        const updatedTask = { ...task, [field]: value };
                        
                        if (field === 'status') {
                            if (value === 'Done') {
                                updatedTask.group = 'group2';
                            } else if (task.status === 'Done' && value !== 'Done') {
                                updatedTask.group = 'group1';
                            }
                        }
                        
                        // Get client type multiplier
                        const getClientTypeMultiplier = (clientType) => {
                            switch (clientType) {
                                case 'Commercial/Local Business':
                                    return 1.0;
                                case 'Out of State Commercial (+30%)':
                                    return 1.3;
                                case 'State Government (+20%)':
                                    return 1.2;
                                case 'Federal Government (+50%)':
                                    return 1.5;
                                case 'Fortune 500 (x2)':
                                    return 2.0;
                                case 'Education (Discount)':
                                    return 0.85; // 15% discount
                                case 'Military/Veteran (-40%)':
                                    return 0.6; // 40% discount
                                default:
                                    return 1.0;
                            }
                        };
                        
                        // When clientType changes, recalculate price based on base price
                        if (field === 'clientType') {
                            // Get the base price (remove old multiplier)
                            const oldMultiplier = getClientTypeMultiplier(task.clientType || 'Commercial/Local Business');
                            const basePrice = parseFloat(task.totalPrice) / oldMultiplier || 0;
                            
                            // Apply new multiplier
                            const newMultiplier = getClientTypeMultiplier(value);
                            updatedTask.totalPrice = String(Math.round(basePrice * newMultiplier));
                            
                            // Recalculate invoice hours
                            const targetInvoiceRate = 65;
                            const calculatedInvoiceHours = Math.round((parseFloat(updatedTask.totalPrice) / targetInvoiceRate) * 2) / 2;
                            updatedTask.workHours = String(calculatedInvoiceHours);
                        }
                        
                        // Auto-calculate Invoice Hours when Work Hours OR Total Price changes
                        // Using the same formula as the calculator: invoiceHours = totalPrice / $65/hr target rate
                        if (field === 'totalPrice' || field === 'actualWorkHours') {
                            const totalPrice = parseFloat(field === 'totalPrice' ? value : task.totalPrice) || 0;
                            const targetInvoiceRate = 65;
                            
                            // Calculate invoice hours: price divided by $65/hr, rounded to nearest 0.5
                            const calculatedInvoiceHours = Math.round((totalPrice / targetInvoiceRate) * 2) / 2;
                            updatedTask.workHours = String(calculatedInvoiceHours);
                        }
                        
                        return updatedTask;
                    }
                    return task;
                }));
            };

            const deleteTask = (id) => {
                setTasks(prev => prev.filter(task => task.id !== id));
                setDeleteConfirm(null);
            };

            const confirmDelete = (task) => {
                setDeleteConfirm(task);
            };

            const addTask = (groupId) => {
                const newTask = {
                    id: Math.max(...tasks.map(t => t.id), 0) + 1,
                    group: groupId,
                    task: 'New Task',
                    clientName: '',
                    person: '',
                    status: 'Not started',
                    priority: 'Standard',
                    clientType: 'Commercial/Local Business',
                    requestDate: new Date().toISOString().split('T')[0],
                    dueDate: '',
                    actualWorkHours: '0',
                    workHours: '0',
                    notes: '',
                    invoiceNumber: '',
                    totalPrice: '0',
                    timeline: ''
                };
                setTasks(prev => [...prev, newTask]);
            };

            const saveDataToFile = () => {
                const dataToSave = {
                    tasks,
                    columnWidths,
                    columnOrder,
                    settings,
                    expandedGroups,
                    savedAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                const jsonString = JSON.stringify(dataToSave, null, 2);
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const filename = `comcam-dashboard-${year}-${month}-${day}_${hours}-${minutes}-${seconds}.json`;
                
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            
            // Save backup with standard name for Google Drive
            const saveBackupForDrive = () => {
                const dataToSave = {
                    tasks,
                    columnWidths,
                    columnOrder,
                    settings,
                    expandedGroups,
                    savedAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                const jsonString = JSON.stringify(dataToSave, null, 2);
                const filename = `COMCAM-BACKUP-LATEST.json`;
                
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('Backup file saved!\n\nðŸ“ File: COMCAM-BACKUP-LATEST.json\n\nâ˜ï¸ Upload this file to your Google Drive to keep a cloud backup.\n\nTip: Create a folder called "COMCAM Backups" in your Drive and always save it there!');
            };
            
            // CSV Report Generation
            const generateCSVReport = (dateRange) => {
                // Filter tasks based on date range
                const now = new Date();
                let startDate, endDate;
                
                switch(dateRange) {
                    case 'thisMonth':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                        break;
                    case 'lastMonth':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                        break;
                    case 'thisQuarter':
                        const currentQuarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), currentQuarter * 3, 1);
                        endDate = new Date(now.getFullYear(), (currentQuarter + 1) * 3, 0);
                        break;
                    case 'lastQuarter':
                        const lastQuarter = Math.floor(now.getMonth() / 3) - 1;
                        const yearAdjust = lastQuarter < 0 ? -1 : 0;
                        const adjustedQuarter = lastQuarter < 0 ? 3 : lastQuarter;
                        startDate = new Date(now.getFullYear() + yearAdjust, adjustedQuarter * 3, 1);
                        endDate = new Date(now.getFullYear() + yearAdjust, (adjustedQuarter + 1) * 3, 0);
                        break;
                    case 'thisYear':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        endDate = new Date(now.getFullYear(), 11, 31);
                        break;
                    case 'lastYear':
                        startDate = new Date(now.getFullYear() - 1, 0, 1);
                        endDate = new Date(now.getFullYear() - 1, 11, 31);
                        break;
                    case 'allTime':
                        startDate = new Date(2000, 0, 1);
                        endDate = new Date(2099, 11, 31);
                        break;
                    default:
                        startDate = new Date(2000, 0, 1);
                        endDate = new Date(2099, 11, 31);
                }
                
                // Filter tasks by request date
                const filteredTasks = tasks.filter(task => {
                    const taskDate = new Date(task.requestDate);
                    return taskDate >= startDate && taskDate <= endDate;
                });
                
                if (filteredTasks.length === 0) {
                    alert('No projects found in this date range!');
                    return;
                }
                
                // CSV Headers
                const headers = [
                    'Project',
                    'Client Name',
                    'Producer',
                    'Status',
                    'Priority',
                    'Client Type',
                    'Request Date',
                    'Due Date',
                    'Work Hours',
                    'Invoice Hours',
                    'Invoice Number',
                    'Total Price',
                    'Timeline (Days)',
                    'Notes'
                ];
                
                // Convert tasks to CSV rows
                const csvRows = filteredTasks.map(task => {
                    return [
                        task.task || '',
                        task.clientName || '',
                        task.person || '',
                        task.status || '',
                        task.priority || '',
                        task.clientType || '',
                        task.requestDate || '',
                        task.dueDate || '',
                        task.actualWorkHours || '0',
                        task.workHours || '0',
                        task.invoiceNumber || '',
                        task.totalPrice || '0',
                        task.timeline || '',
                        (task.notes || '').replace(/"/g, '""') // Escape quotes in notes
                    ].map(field => `"${field}"`).join(',');
                });
                
                // Combine headers and rows
                const csvContent = [headers.join(','), ...csvRows].join('\n');
                
                // Create filename with date range
                const rangeName = dateRange.replace(/([A-Z])/g, '-$1').toLowerCase();
                const filename = `COMCAM-Report-${rangeName}-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}.csv`;
                
                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Show summary
                const totalRevenue = filteredTasks.reduce((sum, task) => sum + (parseFloat(task.totalPrice) || 0), 0);
                const totalHours = filteredTasks.reduce((sum, task) => sum + (parseFloat(task.actualWorkHours) || 0), 0);
                alert(`Report Generated! ðŸ“Š\n\n${filteredTasks.length} projects\n$${totalRevenue.toLocaleString()} total revenue\n${totalHours} work hours\n\nâœ… File saved: ${filename}\n\nYou can now open this in Excel, Google Sheets, or any spreadsheet app to create charts and analyze your data!`);
            };
            
            // Generate Invoice PDF
            const generateInvoice = (task) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'in',
                    format: 'letter'
                });
                
                // Set up styling
                const pageWidth = 8.5;
                const pageHeight = 11;
                const margin = 1.0;
                const contentWidth = pageWidth - (margin * 2);
                
                // Colors based on theme
                const darkColor = [31, 41, 55];      // #1f2937
                const accentColor = [216, 151, 60];  // #D8973C
                const grayColor = [107, 114, 128];   // #6b7280
                
                // COMCAM Company Info
                doc.setTextColor(...darkColor);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('COMCAM', margin, margin + 0.3);
                
                doc.setTextColor(...grayColor);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Professional Video Production Services', margin, margin + 0.55);
                doc.text('Email: info@comcam.com', margin, margin + 0.7);
                doc.text('Phone: (555) 123-4567', margin, margin + 0.85);
                
                // Invoice Title
                doc.setTextColor(...accentColor);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('INVOICE', pageWidth - margin, margin + 0.3, { align: 'right' });
                
                // Invoice Details
                doc.setTextColor(...darkColor);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Invoice #: ${task.invoiceNumber || 'N/A'}`, pageWidth - margin, margin + 0.65, { align: 'right' });
                doc.text(`Date: ${new Date().toLocaleDateString()}`, pageWidth - margin, margin + 0.8, { align: 'right' });
                doc.text(`Due Date: ${task.dueDate || new Date().toLocaleDateString()}`, pageWidth - margin, margin + 0.95, { align: 'right' });
                
                // Bill To Section
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('BILL TO:', margin, margin + 1.5);
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(task.clientName || 'Client Name', margin, margin + 1.7);
                
                // Show adjustment label if applicable (only for discounts and transparent surcharges)
                if (hasDiscount) {
                    doc.setTextColor(...accentColor);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${adjustmentLabel} Applied (-${adjustmentPercent}%)`, margin, margin + 1.9);
                    doc.setTextColor(...darkColor);
                } else if (hasSurcharge) {
                    doc.setTextColor(...accentColor);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${adjustmentLabel} Applied (+${adjustmentPercent}%)`, margin, margin + 1.9);
                    doc.setTextColor(...darkColor);
                }
                
                // Table Header
                let yPos = margin + 2.5;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('PROJECT DESCRIPTION', margin, yPos);
                doc.text('HOURS', margin + 3.5, yPos);
                doc.text('RATE', margin + 4.5, yPos);
                doc.text('AMOUNT', pageWidth - margin, yPos, { align: 'right' });
                
                // Line under header
                yPos += 0.05;
                doc.setDrawColor(...grayColor);
                doc.setLineWidth(0.01);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                
                // Calculate values
                const hours = parseFloat(task.workHours) || 0;
                const finalAmount = parseFloat(task.totalPrice) || 0;
                
                // Determine if there's a discount or surcharge
                let hasDiscount = false;
                let hasSurcharge = false;
                let adjustmentPercent = 0;
                let baseAmount = finalAmount;
                let adjustmentAmount = 0;
                let baseRate = 0;
                let adjustmentLabel = '';
                
                if (task.clientType) {
                    // Check for discounts (price reductions) - ALWAYS SHOW
                    if (task.clientType.includes('Military') || task.clientType.includes('Veteran')) {
                        hasDiscount = true;
                        adjustmentPercent = 40;
                        adjustmentLabel = 'Military/Veteran Discount';
                        // Back-calculate the original amount
                        baseAmount = finalAmount / (1 - adjustmentPercent / 100);
                        adjustmentAmount = baseAmount - finalAmount;
                        baseRate = hours > 0 ? baseAmount / hours : 0;
                    }
                    else if (task.clientType.includes('Education')) {
                        hasDiscount = true;
                        adjustmentPercent = 15;
                        adjustmentLabel = 'Education Discount';
                        // Back-calculate the original amount
                        baseAmount = finalAmount / (1 - adjustmentPercent / 100);
                        adjustmentAmount = baseAmount - finalAmount;
                        baseRate = hours > 0 ? baseAmount / hours : 0;
                    }
                    // Check for surcharges - ONLY SHOW for Out of State and Government
                    else if (task.clientType.includes('Out of State')) {
                        hasSurcharge = true;
                        adjustmentPercent = 30;
                        adjustmentLabel = 'Out of State Service Fee';
                        // Back-calculate the base amount
                        baseAmount = finalAmount / (1 + adjustmentPercent / 100);
                        adjustmentAmount = finalAmount - baseAmount;
                        baseRate = hours > 0 ? baseAmount / hours : 0;
                    }
                    else if (task.clientType.includes('State Government')) {
                        hasSurcharge = true;
                        adjustmentPercent = 20;
                        adjustmentLabel = 'Government Contract Fee';
                        baseAmount = finalAmount / (1 + adjustmentPercent / 100);
                        adjustmentAmount = finalAmount - baseAmount;
                        baseRate = hours > 0 ? baseAmount / hours : 0;
                    }
                    else if (task.clientType.includes('Federal Government')) {
                        hasSurcharge = true;
                        adjustmentPercent = 50;
                        adjustmentLabel = 'Federal Contract Fee';
                        baseAmount = finalAmount / (1 + adjustmentPercent / 100);
                        adjustmentAmount = finalAmount - baseAmount;
                        baseRate = hours > 0 ? baseAmount / hours : 0;
                    }
                    // Fortune 500 - Don't show breakdown, just use final amount
                    else if (task.clientType.includes('Fortune 500')) {
                        // Price already includes markup, just use it directly
                        baseRate = hours > 0 ? finalAmount / hours : 0;
                        baseAmount = finalAmount;
                    }
                }
                
                if (!hasDiscount && !hasSurcharge && hours > 0) {
                    baseRate = finalAmount / hours;
                    baseAmount = finalAmount;
                }
                
                // Line Item
                yPos += 0.25;
                doc.setFont('helvetica', 'normal');
                const projectName = task.task || 'Video Production Services';
                doc.text(projectName, margin, yPos);
                doc.text(hours.toFixed(1), margin + 3.5, yPos);
                doc.text(`$${baseRate.toFixed(2)}`, margin + 4.5, yPos);
                doc.text(`$${baseAmount.toFixed(2)}`, pageWidth - margin, yPos, { align: 'right' });
                
                // Notes if any
                if (task.notes) {
                    yPos += 0.15;
                    doc.setFontSize(9);
                    doc.setTextColor(...grayColor);
                    doc.setFont('helvetica', 'italic');
                    const wrappedNotes = doc.splitTextToSize(task.notes, contentWidth - 0.2);
                    doc.text(wrappedNotes, margin + 0.1, yPos);
                    doc.setTextColor(...darkColor);
                }
                
                // Subtotal and Adjustment Section (show breakdown for both discounts and surcharges)
                yPos += 0.5;
                
                if (hasDiscount || hasSurcharge) {
                    // Show full breakdown
                    doc.setDrawColor(...grayColor);
                    doc.setLineWidth(0.01);
                    doc.line(margin + 3.5, yPos, pageWidth - margin, yPos);
                    
                    // Subtotal
                    yPos += 0.25;
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Subtotal:', margin + 3.5, yPos);
                    doc.text(`$${baseAmount.toFixed(2)}`, pageWidth - margin, yPos, { align: 'right' });
                    
                    // Adjustment line (discount or surcharge)
                    yPos += 0.2;
                    doc.setTextColor(...accentColor);
                    doc.setFont('helvetica', 'bold');
                    if (hasDiscount) {
                        doc.text(`${adjustmentLabel} (${adjustmentPercent}%):`, margin + 3.5, yPos);
                        doc.text(`-$${adjustmentAmount.toFixed(2)}`, pageWidth - margin, yPos, { align: 'right' });
                    } else if (hasSurcharge) {
                        doc.text(`${adjustmentLabel} (${adjustmentPercent}%):`, margin + 3.5, yPos);
                        doc.text(`+$${adjustmentAmount.toFixed(2)}`, pageWidth - margin, yPos, { align: 'right' });
                    }
                    doc.setTextColor(...darkColor);
                    
                    // Total - with bold line
                    yPos += 0.3;
                } else {
                    // For standard pricing, just show a line and go to total
                    doc.setDrawColor(...grayColor);
                    doc.setLineWidth(0.01);
                    doc.line(margin + 3.5, yPos, pageWidth - margin, yPos);
                    yPos += 0.3;
                }
                
                // Total line
                doc.setDrawColor(...darkColor);
                doc.setLineWidth(0.03);
                doc.line(margin + 3.5, yPos, pageWidth - margin, yPos);
                
                yPos += 0.3;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL:', margin + 3.5, yPos);
                doc.text(`$${finalAmount.toFixed(2)}`, pageWidth - margin, yPos, { align: 'right' });
                
                // Payment Terms
                yPos += 0.6;
                doc.setTextColor(...grayColor);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'italic');
                doc.text('Payment Terms: Net 30 days. Please make checks payable to COMCAM.', margin, yPos);
                
                // Thank You
                yPos += 0.4;
                doc.setTextColor(...darkColor);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                const thankYouText = 'Thank you for your business!';
                const thankYouWidth = doc.getTextWidth(thankYouText);
                doc.text(thankYouText, (pageWidth - thankYouWidth) / 2, yPos);
                
                // Legal Footer
                doc.setFontSize(8);
                doc.setTextColor(...grayColor);
                const footerText = 'COMCAM LLC | EIN: XX-XXXXXXX | Licensed & Insured';
                const footerWidth = doc.getTextWidth(footerText);
                doc.text(footerText, (pageWidth - footerWidth) / 2, pageHeight - 0.5);
                
                // Save PDF
                const filename = `Invoice_${task.invoiceNumber || task.id}_${task.clientName?.replace(/[^a-zA-Z0-9]/g, '_') || 'Client'}.pdf`;
                doc.save(filename);
            };
            
            // Firebase Functions (replacing old API functions)
            const checkApiConnection = async () => {
                try {
                    // Check if Firebase is initialized and we can connect
                    if (!database) {
                        setApiConnected(false);
                        return false;
                    }
                    
                    // Test connection by checking .info/connected
                    const connectedRef = database.ref('.info/connected');
                    const snapshot = await connectedRef.once('value');
                    const connected = snapshot.val() === true;
                    setApiConnected(connected);
                    return connected;
                } catch (error) {
                    console.error('Firebase connection error:', error);
                    setApiConnected(false);
                    return false;
                }
            };

            const fetchNewRequests = async () => {
                setIsLoadingRequests(true);
                try {
                    if (!database) {
                        throw new Error('Firebase not initialized');
                    }
                    
                    // Fetch all requests from Firebase
                    const snapshot = await database.ref('requests').once('value');
                    const data = snapshot.val();
                    
                    if (!data) {
                        setNewRequests([]);
                        setUnreadCount(0);
                        setApiConnected(true);
                        return;
                    }
                    
                    // Convert to array and filter unread
                    const allRequests = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));
                    
                    const unread = allRequests.filter(r => !r.read);
                    setNewRequests(unread);
                    setUnreadCount(unread.length);
                    setApiConnected(true);
                } catch (error) {
                    console.error('Error fetching requests from Firebase:', error);
                    setApiConnected(false);
                } finally {
                    setIsLoadingRequests(false);
                }
            };

            const importRequest = async (request) => {
                // Create a new task from the request
                const newTask = {
                    id: Math.max(...tasks.map(t => t.id), 0) + 1,
                    group: 'group1', // Add to INBOX
                    task: request.task || request.projectName || 'New Request',
                    clientName: request.clientName || '',
                    person: request.person || '',
                    status: request.status || 'Not started',
                    priority: request.priority || 'Standard',
                    clientType: request.clientType || 'Commercial/Local Business',
                    requestDate: request.requestDate || new Date().toISOString().split('T')[0],
                    dueDate: request.dueDate || '',
                    actualWorkHours: String(request.actualWorkHours || request.workHours || '0'),
                    workHours: String(request.workHours || '0'),
                    notes: request.notes || request.projectDescription || '',
                    invoiceNumber: request.invoiceNumber || '',
                    totalPrice: String(request.totalPrice || '0'),
                    timeline: String(request.timeline || '')
                };
                
                setTasks(prev => [...prev, newTask]);
                
                // Mark as read in Firebase
                try {
                    await database.ref(`requests/${request.id}/read`).set(true);
                } catch (error) {
                    console.error('Error marking request as read in Firebase:', error);
                }
                
                // Remove from new requests list
                setNewRequests(prev => prev.filter(r => r.id !== request.id));
                setUnreadCount(prev => Math.max(0, prev - 1));
                
                return newTask;
            };

            const dismissRequest = async (requestId) => {
                try {
                    // Mark as read in Firebase without importing
                    await database.ref(`requests/${requestId}/read`).set(true);
                    
                    setNewRequests(prev => prev.filter(r => r.id !== requestId));
                    setUnreadCount(prev => Math.max(0, prev - 1));
                } catch (error) {
                    console.error('Error dismissing request in Firebase:', error);
                }
            };

            // Authentication listener
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                    if (currentUser) {
                        console.log('âœ… User authenticated:', currentUser.email);
                    }
                });
                return () => unsubscribe();
            }, []);

            // Load data from Firebase when user logs in - WITH REAL-TIME SYNC
            useEffect(() => {
                if (user && database) {
                    console.log('ðŸ“¥ Setting up real-time Firebase sync...');
                    setFirebaseSynced(false);
                    setInitialLoadComplete(false);
                    
                    let loadedCount = 0;
                    const totalLoads = 5;
                    
                    const checkAllLoaded = () => {
                        loadedCount++;
                        if (loadedCount === totalLoads) {
                            setFirebaseSynced(true);
                            setInitialLoadComplete(true);
                            console.log('âœ… All data synced with Firebase - real-time updates active');
                        }
                    };
                    
                    // Real-time listener for tasks
                    const tasksRef = database.ref('userData/tasks');
                    const tasksListener = tasksRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data && Array.isArray(data)) {
                            setTasks(data);
                            localStorage.setItem('comcam_tasks', JSON.stringify(data));
                            console.log('ðŸ”„ Tasks updated from Firebase:', data.length, 'tasks');
                        }
                        if (loadedCount < totalLoads) checkAllLoaded();
                    });

                    // Real-time listener for column widths
                    const widthsRef = database.ref('userData/columnWidths');
                    const widthsListener = widthsRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setColumnWidths(data);
                            localStorage.setItem('comcam_columnWidths_v2', JSON.stringify(data));
                            console.log('ðŸ”„ Column widths updated from Firebase');
                        }
                        if (loadedCount < totalLoads) checkAllLoaded();
                    });

                    // Real-time listener for column order
                    const orderRef = database.ref('userData/columnOrder');
                    const orderListener = orderRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data && Array.isArray(data)) {
                            setColumnOrder(data);
                            localStorage.setItem('comcam_columnOrder_v2', JSON.stringify(data));
                            console.log('ðŸ”„ Column order updated from Firebase');
                        }
                        if (loadedCount < totalLoads) checkAllLoaded();
                    });

                    // Real-time listener for expanded groups
                    const groupsRef = database.ref('userData/expandedGroups');
                    const groupsListener = groupsRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setExpandedGroups(data);
                            localStorage.setItem('comcam_expandedGroups', JSON.stringify(data));
                            console.log('ðŸ”„ Expanded groups updated from Firebase');
                        }
                        if (loadedCount < totalLoads) checkAllLoaded();
                    });

                    // Real-time listener for settings
                    const settingsRef = database.ref('userData/settings');
                    const settingsListener = settingsRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setSettings(data);
                            localStorage.setItem('comcam_settings', JSON.stringify(data));
                            console.log('ðŸ”„ Settings updated from Firebase:', data);
                        }
                        if (loadedCount < totalLoads) checkAllLoaded();
                    });
                    
                    // Cleanup: Remove listeners when component unmounts or user logs out
                    return () => {
                        console.log('ðŸ”Œ Disconnecting Firebase real-time listeners');
                        tasksRef.off('value', tasksListener);
                        widthsRef.off('value', widthsListener);
                        orderRef.off('value', orderListener);
                        groupsRef.off('value', groupsListener);
                        settingsRef.off('value', settingsListener);
                    };
                }
            }, [user]);

            // Login function
            const handleLogin = async (e) => {
                e.preventDefault();
                setAuthError('');
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    console.error('Login error:', error);
                    setAuthError(error.message);
                }
            };

            // Logout function
            const handleLogout = async () => {
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('Logout error:', error);
                }
            };

            // Check API connection and fetch requests on mount
            useEffect(() => {
                checkApiConnection();
                fetchNewRequests();
                
                // Poll for new requests every 60 seconds (if enabled)
                if (settings.autoRefresh) {
                    const interval = setInterval(fetchNewRequests, 60000);
                    return () => clearInterval(interval);
                }
            }, [settings.autoRefresh]);
            
            const handleFileLoad = (event) => {
                console.log('File input changed');
                const file = event.target.files[0];
                if (!file) {
                    console.log('No file selected');
                    return;
                }

                console.log('File selected:', file.name);
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        console.log('File content loaded, length:', content.length);
                        const loadedData = JSON.parse(content);
                        console.log('JSON parsed successfully:', loadedData);
                        
                        let updated = false;
                        
                        // Check if this is a single task from the calculator (has task, clientName, but no tasks array)
                        if (loadedData.task && loadedData.clientName && !loadedData.tasks) {
                            console.log('Detected single task from calculator, importing...');
                            
                            // Create a new task with a unique ID
                            const newTask = {
                                id: Math.max(...tasks.map(t => t.id), 0) + 1,
                                group: 'group1', // Add to INBOX
                                task: loadedData.task || 'Imported Project',
                                clientName: loadedData.clientName || '',
                                person: loadedData.person || '',
                                status: loadedData.status || 'Not started',
                                priority: loadedData.priority || 'Standard',
                                clientType: loadedData.clientType || 'Commercial/Local Business',
                                requestDate: loadedData.requestDate || new Date().toISOString().split('T')[0],
                                dueDate: loadedData.dueDate || '',
                                actualWorkHours: loadedData.actualWorkHours || loadedData.workHours || '0',
                                workHours: loadedData.workHours || '0',
                                notes: loadedData.notes || '',
                                invoiceNumber: loadedData.invoiceNumber || '',
                                totalPrice: loadedData.totalPrice || '0',
                                timeline: loadedData.timeline || ''
                            };
                            
                            setTasks(prev => [...prev, newTask]);
                            alert(`âœ… Invoice imported successfully!\n\nProject: ${newTask.task}\nClient: ${newTask.clientName}\nInvoice #: ${newTask.invoiceNumber}\nTotal: $${newTask.totalPrice}\n\nThe task has been added to your INBOX.`);
                            updated = true;
                        }
                        // Otherwise check if it's a full dashboard export
                        else if (loadedData.tasks && Array.isArray(loadedData.tasks)) {
                            console.log('Loading full dashboard data with', loadedData.tasks.length, 'tasks');
                            setTasks(loadedData.tasks);
                            updated = true;
                            
                            if (loadedData.columnWidths && typeof loadedData.columnWidths === 'object') {
                                console.log('Loading column widths');
                                setColumnWidths(loadedData.columnWidths);
                            }
                            if (loadedData.columnOrder && Array.isArray(loadedData.columnOrder)) {
                                console.log('Loading column order');
                                setColumnOrder(loadedData.columnOrder);
                            }
                            if (loadedData.settings && typeof loadedData.settings === 'object') {
                                console.log('Loading settings');
                                setSettings(loadedData.settings);
                            }
                            if (loadedData.expandedGroups && typeof loadedData.expandedGroups === 'object') {
                                console.log('Loading expanded groups');
                                setExpandedGroups(loadedData.expandedGroups);
                            }
                            
                            alert('âœ… Dashboard data loaded successfully!');
                        }
                        
                        if (!updated) {
                            alert('âš ï¸ File loaded but no valid data found. Make sure the file contains either:\n\nâ€¢ A single task/invoice from the calculator\nâ€¢ Full dashboard data with tasks array');
                        }
                    } catch (error) {
                        alert('âŒ Error loading file: ' + error.message + '\n\nPlease ensure it is a valid JSON file.');
                        console.error('Error loading file:', error);
                    }
                };
                reader.onerror = (error) => {
                    alert('âŒ Error reading file: ' + error);
                    console.error('FileReader error:', error);
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const handleDragStart = (e, task) => {
                setDraggedTask(task);
                try { e.dataTransfer.setData('text/plain', String(task.id)); } catch {}
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => {
                    if (e.currentTarget && e.currentTarget.style) e.currentTarget.style.opacity = '0.5';
                }, 0);
            };

            const handleDragEnd = (e) => {
                if (e.currentTarget && e.currentTarget.style) e.currentTarget.style.opacity = '1';
                setDraggedTask(null);
                setDragOverTask(null);
            };

            const handleDragOver = (e, task) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (draggedTask && task.id !== draggedTask.id) {
                    setDragOverTask(task);
                }
            };

            const handleDragLeave = () => {
                setDragOverTask(null);
            };

            const handleDrop = (e, targetTask) => {
                e.preventDefault();
                if (!draggedTask || draggedTask.id === targetTask.id) {
                    setDragOverTask(null);
                    return;
                }
                const newTasks = [...tasks];
                const draggedIndex = newTasks.findIndex(t => t.id === draggedTask.id);
                const targetIndex = newTasks.findIndex(t => t.id === targetTask.id);
                const [removed] = newTasks.splice(draggedIndex, 1);
                newTasks.splice(targetIndex, 0, removed);
                setTasks(newTasks);
                setDragOverTask(null);
                setDraggedTask(null);
            };

            const handleColumnDragStart = (e, columnKey) => {
                setDraggedColumn(columnKey);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleColumnDragOver = (e, columnKey) => {
                e.preventDefault();
                if (draggedColumn && draggedColumn !== columnKey) {
                    const newOrder = [...columnOrder];
                    const draggedIndex = newOrder.indexOf(draggedColumn);
                    const targetIndex = newOrder.indexOf(columnKey);
                    newOrder.splice(draggedIndex, 1);
                    newOrder.splice(targetIndex, 0, draggedColumn);
                    setColumnOrder(newOrder);
                }
            };

            const handleColumnDragEnd = () => {
                setDraggedColumn(null);
            };

            const handleResizeStart = (e, columnKey) => {
                e.preventDefault();
                e.stopPropagation();
                setResizingColumn(columnKey);
                resizeStartX.current = e.clientX;
                resizeStartWidth.current = columnWidths[columnKey];
            };

            const handleMouseMove = useCallback((e) => {
                if (resizingColumn) {
                    const diff = e.clientX - resizeStartX.current;
                    const newWidth = Math.max(80, resizeStartWidth.current + diff);
                    setColumnWidths(prev => ({
                        ...prev,
                        [resizingColumn]: newWidth
                    }));
                }
            }, [resizingColumn]);

            const handleMouseUp = useCallback(() => {
                if (resizingColumn) {
                    setResizingColumn(null);
                }
            }, [resizingColumn]);

            useEffect(() => {
                if (resizingColumn) {
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                }
                return () => {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                };
            }, [resizingColumn, handleMouseMove, handleMouseUp]);

            // Auto-save to localStorage AND Firebase whenever data changes
            useEffect(() => {
                try {
                    localStorage.setItem('comcam_tasks', JSON.stringify(tasks));
                    // Only save to Firebase if authenticated AND initial load is complete
                    if (user && database && initialLoadComplete) {
                        database.ref('userData/tasks').set(tasks);
                        console.log('ðŸ’¾ Tasks saved to Firebase');
                    }
                } catch (error) {
                    console.error('Error saving tasks:', error);
                }
            }, [tasks, user, initialLoadComplete]);

            useEffect(() => {
                try {
                    localStorage.setItem('comcam_columnWidths_v2', JSON.stringify(columnWidths));
                    if (user && database && initialLoadComplete) {
                        database.ref('userData/columnWidths').set(columnWidths);
                        console.log('ðŸ’¾ Column widths saved to Firebase');
                    }
                } catch (error) {
                    console.error('Error saving columnWidths:', error);
                }
            }, [columnWidths, user, initialLoadComplete]);

            useEffect(() => {
                try {
                    localStorage.setItem('comcam_columnOrder_v2', JSON.stringify(columnOrder));
                    if (user && database && initialLoadComplete) {
                        database.ref('userData/columnOrder').set(columnOrder);
                        console.log('ðŸ’¾ Column order saved to Firebase');
                    }
                } catch (error) {
                    console.error('Error saving columnOrder:', error);
                }
            }, [columnOrder, user, initialLoadComplete]);

            useEffect(() => {
                try {
                    localStorage.setItem('comcam_expandedGroups', JSON.stringify(expandedGroups));
                    if (user && database && initialLoadComplete) {
                        database.ref('userData/expandedGroups').set(expandedGroups);
                        console.log('ðŸ’¾ Expanded groups saved to Firebase');
                    }
                } catch (error) {
                    console.error('Error saving expandedGroups:', error);
                }
            }, [expandedGroups, user, initialLoadComplete]);

            useEffect(() => {
                try {
                    localStorage.setItem('comcam_settings', JSON.stringify(settings));
                    if (user && database && initialLoadComplete) {
                        database.ref('userData/settings').set(settings);
                        console.log('ðŸ’¾ Settings saved to Firebase');
                    }
                } catch (error) {
                    console.error('Error saving settings:', error);
                }
            }, [settings, user, initialLoadComplete]);

            const EditableCell = ({ value, taskId, field }) => {
                const [isEditing, setIsEditing] = useState(false);
                const [tempValue, setTempValue] = useState(value);

                const handleSave = () => {
                    updateTask(taskId, field, tempValue);
                    setIsEditing(false);
                };

                if (isEditing) {
                    return (
                        <input
                            type="text"
                            value={tempValue}
                            onChange={(e) => setTempValue(e.target.value)}
                            onBlur={handleSave}
                            onKeyPress={(e) => e.key === 'Enter' && handleSave()}
                            className="w-full px-2 py-1 border border-blue-500 rounded focus:outline-none"
                            style={{
                                backgroundColor: settings.darkMode ? '#3a3a3a' : '#ffffff',
                                color: settings.darkMode ? '#ffffff' : '#1f2937'
                            }}
                            autoFocus
                        />
                    );
                }

                return (
                    <div
                        onClick={() => setIsEditing(true)}
                        className="cursor-pointer px-2 py-1 rounded min-h-[24px]"
                        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = settings.darkMode ? '#3a3a3a' : '#f9fafb'}
                        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                    >
                        {value || <span className="italic opacity-60">Click to edit</span>}
                    </div>
                );
            };

            const StatusCell = ({ status, taskId, isExpanded, onToggle }) => {
                const options = ['Working on it', 'Done', 'Stuck', 'Not started'];

                return (
                    <div className="w-full">
                        <button
                            onClick={onToggle}
                            style={{ 
                                backgroundColor: statusColors[status],
                                boxShadow: isExpanded ? '0 0 0 3px rgba(59, 130, 246, 0.2)' : 'none',
                                transition: 'all 2s ease'
                            }}
                            className="text-white px-3 py-2 rounded text-sm font-medium hover:opacity-90 w-full text-left flex items-center justify-between"
                        >
                            <span>{status}</span>
                            <div className="chevron-rotate" style={{ transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)' }}>
                                <ChevronDown />
                            </div>
                        </button>
                        {isExpanded && (
                            <div className="mt-3 rounded-lg shadow-xl border-2 p-2 space-y-2" style={{
                                borderColor: '#3b82f6',
                                backgroundColor: settings.darkMode ? '#2a2a2a' : '#ffffff',
                                animation: 'slideDown 2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards',
                                width: '200px'
                            }}>
                                {options.map(option => (
                                    <button
                                        key={option}
                                        onClick={() => {
                                            updateTask(taskId, 'status', option);
                                            onToggle();
                                        }}
                                        style={{ backgroundColor: statusColors[option] }}
                                        className="text-white px-4 py-3 w-full text-left text-sm font-semibold rounded-lg hover:scale-105 hover:shadow-lg transition-all duration-2000"
                                    >
                                        {option}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            const PriorityCell = ({ priority, taskId, task, isExpanded, onToggle }) => {
                const options = ['Standard', 'High'];
                
                const shouldShowWarning = () => {
                    if (!settings.dueDateWarning || !task.dueDate) return false;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const dueDate = new Date(task.dueDate);
                    dueDate.setHours(0, 0, 0, 0);
                    const diffTime = dueDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays <= 1 && diffDays >= 0;
                };
                
                const displayColor = shouldShowWarning() ? '#ff7575' : priorityColors[priority];

                return (
                    <div className="w-full">
                        <button
                            onClick={onToggle}
                            style={{ 
                                backgroundColor: displayColor,
                                boxShadow: isExpanded ? '0 0 0 3px rgba(59, 130, 246, 0.2)' : 'none',
                                transition: 'all 2s ease'
                            }}
                            className="text-gray-800 px-3 py-2 rounded text-sm font-medium hover:opacity-90 w-full text-left flex items-center justify-between"
                        >
                            <span>{priority}</span>
                            <div className="chevron-rotate" style={{ transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)' }}>
                                <ChevronDown />
                            </div>
                        </button>
                        {isExpanded && (
                            <div className="mt-3 rounded-lg shadow-xl border-2 p-3 space-y-3" style={{
                                borderColor: '#3b82f6',
                                backgroundColor: settings.darkMode ? '#2a2a2a' : '#ffffff',
                                animation: 'slideDown 2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards',
                                width: '200px'
                            }}>
                                {options.map((option, index) => (
                                    <button
                                        key={option}
                                        onClick={() => {
                                            updateTask(taskId, 'priority', option);
                                            onToggle();
                                        }}
                                        style={{ 
                                            backgroundColor: priorityColors[option],
                                            animationDelay: `${index * 0.4}s`
                                        }}
                                        className="text-gray-800 px-5 py-4 w-full text-left text-base font-bold rounded-lg hover:scale-110 hover:shadow-2xl transition-all duration-2000 animate-fade-in"
                                    >
                                        {option}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            const ClientTypeCell = ({ clientType, taskId, isExpanded, onToggle }) => {
                const options = [
                    'Commercial/Local Business',
                    'Out of State Commercial (+30%)',
                    'State Government (+20%)',
                    'Federal Government (+50%)',
                    'Fortune 500 (x2)',
                    'Education (Discount)',
                    'Military/Veteran (-40%)'
                ];

                return (
                    <div className="w-full">
                        <button
                            onClick={onToggle}
                            style={{ 
                                backgroundColor: clientTypeColors[clientType] || '#81b6e3',
                                boxShadow: isExpanded ? '0 0 0 3px rgba(59, 130, 246, 0.2)' : 'none',
                                transition: 'all 2s ease'
                            }}
                            className="text-gray-800 px-3 py-2 rounded text-sm font-medium hover:opacity-90 w-full text-left flex items-center justify-between"
                        >
                            <span className="truncate">{clientType || 'Commercial/Local Business'}</span>
                            <div className="chevron-rotate flex-shrink-0" style={{ transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)' }}>
                                <ChevronDown />
                            </div>
                        </button>
                        {isExpanded && (
                            <div className="mt-3 rounded-lg shadow-xl border-2 p-2 space-y-2 max-h-80 overflow-y-auto" style={{
                                borderColor: '#3b82f6',
                                backgroundColor: settings.darkMode ? '#2a2a2a' : '#ffffff',
                                animation: 'slideDown 2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards',
                                width: '280px'
                            }}>
                                {options.map(option => (
                                    <button
                                        key={option}
                                        onClick={() => {
                                            updateTask(taskId, 'clientType', option);
                                            onToggle();
                                        }}
                                        style={{ backgroundColor: clientTypeColors[option] }}
                                        className="text-gray-800 px-4 py-3 w-full text-left text-sm font-semibold rounded-lg hover:scale-105 hover:shadow-lg transition-all duration-2000"
                                    >
                                        {option}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            const renderCell = (columnKey, task) => {
                switch (columnKey) {
                    case 'task':
                        return (
                            <div className="flex items-center gap-2">
                                <EditableCell value={task.task} taskId={task.id} field="task" />
                            </div>
                        );
                    case 'clientName':
                        return <EditableCell value={task.clientName} taskId={task.id} field="clientName" />;
                    case 'person':
                        return (
                            <div className="flex items-center gap-2">
                                {task.person && (
                                    <div className="w-8 h-8 rounded-full flex items-center justify-center text-white font-semibold text-sm" style={{ backgroundColor: '#cbb045' }}>
                                        {task.person.split(' ').map(n => n[0]).join('')}
                                    </div>
                                )}
                                <EditableCell value={task.person} taskId={task.id} field="person" />
                            </div>
                        );
                    case 'status':
                        return (
                            <StatusCell 
                                status={task.status} 
                                taskId={task.id}
                                isExpanded={expandedDropdown === `${task.id}-status`}
                                onToggle={() => setExpandedDropdown(
                                    expandedDropdown === `${task.id}-status` ? null : `${task.id}-status`
                                )}
                            />
                        );
                    case 'priority':
                        return (
                            <PriorityCell 
                                priority={task.priority} 
                                taskId={task.id} 
                                task={task}
                                isExpanded={expandedDropdown === `${task.id}-priority`}
                                onToggle={() => setExpandedDropdown(
                                    expandedDropdown === `${task.id}-priority` ? null : `${task.id}-priority`
                                )}
                            />
                        );
                    case 'clientType':
                        return (
                            <ClientTypeCell 
                                clientType={task.clientType} 
                                taskId={task.id}
                                isExpanded={expandedDropdown === `${task.id}-clientType`}
                                onToggle={() => setExpandedDropdown(
                                    expandedDropdown === `${task.id}-clientType` ? null : `${task.id}-clientType`
                                )}
                            />
                        );
                    case 'requestDate':
                        return (
                            <InlineCalendar 
                                value={task.requestDate}
                                onChange={(dateStr) => updateTask(task.id, 'requestDate', dateStr)}
                                darkMode={settings.darkMode}
                                isExpanded={expandedDropdown === `${task.id}-requestDate`}
                                onToggle={() => setExpandedDropdown(
                                    expandedDropdown === `${task.id}-requestDate` ? null : `${task.id}-requestDate`
                                )}
                            />
                        );
                    case 'dueDate':
                        return (
                            <InlineCalendar 
                                value={task.dueDate}
                                onChange={(dateStr) => updateTask(task.id, 'dueDate', dateStr)}
                                darkMode={settings.darkMode}
                                isExpanded={expandedDropdown === `${task.id}-dueDate`}
                                onToggle={() => setExpandedDropdown(
                                    expandedDropdown === `${task.id}-dueDate` ? null : `${task.id}-dueDate`
                                )}
                            />
                        );
                    case 'actualWorkHours':
                        return (
                            <input
                                type="number"
                                value={task.actualWorkHours}
                                onChange={(e) => updateTask(task.id, 'actualWorkHours', e.target.value)}
                                className="border rounded px-2 py-1 text-sm hover:border-blue-400 focus:outline-none focus:border-blue-500 w-full"
                                style={{
                                    borderColor: settings.darkMode ? '#4a4a4a' : '#e5e7eb',
                                    backgroundColor: settings.darkMode ? '#3a3a3a' : '#ffffff',
                                    color: settings.darkMode ? '#ffffff' : '#1f2937'
                                }}
                                min="0"
                                step="0.5"
                                placeholder="0"
                            />
                        );
                    case 'workHours':
                        return (
                            <div className="relative group">
                                <input
                                    type="number"
                                    value={task.workHours}
                                    readOnly
                                    className="border border-green-200 bg-green-50 rounded px-2 py-1 text-sm w-full text-green-700 font-semibold cursor-not-allowed"
                                    min="0"
                                    step="0.5"
                                    title="Auto-calculated from Total Price Ã· $65/hr"
                                />
                                <div className="absolute hidden group-hover:block bg-gray-900 text-white text-xs rounded px-2 py-1 -top-8 left-0 whitespace-nowrap z-50">
                                    Auto-calculated: ${task.totalPrice || 0} Ã· $65/hr
                                </div>
                            </div>
                        );
                    case 'notes':
                        return <EditableCell value={task.notes} taskId={task.id} field="notes" />;
                    case 'invoiceNumber':
                        return <EditableCell value={task.invoiceNumber} taskId={task.id} field="invoiceNumber" />;
                    case 'totalPrice':
                        return (
                            <div className="font-semibold text-green-700">
                                <EditableCell value={task.totalPrice} taskId={task.id} field="totalPrice" />
                            </div>
                        );
                    case 'timeline':
                        return <EditableCell value={task.timeline} taskId={task.id} field="timeline" />;
                    case 'invoice':
                        return (
                            <div className="flex items-center justify-center">
                                <button
                                    onClick={() => generateInvoice(task)}
                                    className="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-3 py-2 rounded-lg shadow-md hover:shadow-lg transition-all transform hover:scale-105 text-xs font-medium"
                                    title="Generate Invoice PDF"
                                >
                                    ðŸ“„ Invoice
                                </button>
                            </div>
                        );
                    case 'metrics':
                        return (
                            <div className="flex items-center justify-center">
                                <button
                                    onClick={() => setSelectedTaskForMetrics(task)}
                                    className="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white p-2 rounded-lg shadow-md hover:shadow-lg transition-all transform hover:scale-105"
                                    title="View metrics"
                                >
                                    <BarChart size={18} />
                                </button>
                            </div>
                        );
                    case 'drag':
                        return (
                            <div className="flex items-center justify-center">
                                <GripVertical size={16} className="text-gray-400 cursor-move" />
                            </div>
                        );
                    case 'actions':
                        return (
                            <button
                                onClick={() => confirmDelete(task)}
                                className="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded transition-colors"
                                title="Delete task"
                            >
                                <Trash2 size={18} />
                            </button>
                        );
                    default:
                        return null;
                }
            };

            const columns = {
                task: { label: 'Project', icon: null },
                clientName: { label: 'Client Name', icon: <User size={16} /> },
                person: { label: 'Producer', icon: <User size={16} /> },
                status: { label: 'Status', icon: null },
                priority: { label: 'Priority', icon: null },
                clientType: { label: 'Client Type', icon: null },
                requestDate: { label: 'Request Date', icon: <Calendar size={16} /> },
                dueDate: { label: 'Due Date', icon: <Calendar size={16} /> },
                actualWorkHours: { label: 'Work Hours', icon: null },
                workHours: { label: 'Invoice Hours', icon: null },
                notes: { label: 'Notes', icon: null },
                invoiceNumber: { label: 'Invoice Number', icon: null },
                totalPrice: { label: 'Total Price', icon: <span className="text-green-600">$</span> },
                timeline: { label: 'Timeline (Days)', icon: null },
                invoice: { label: 'Invoice', icon: null },
                metrics: { label: 'Metrics', icon: <BarChart size={16} /> },
                drag: { label: '', icon: null },
                actions: { label: '', icon: null }
            };

            const GroupHeader = ({ title, groupId, count, bgColor }) => (
                <div className="px-4 py-3 flex items-center justify-between rounded-lg mb-2 shadow-sm" style={{ backgroundColor: bgColor, color: getTextColor(bgColor) }}>
                    <div className="flex items-center gap-3">
                        <button
                            onClick={() => toggleGroup(groupId)}
                            className="hover:bg-white/20 rounded p-1 transition-colors"
                        >
                            {expandedGroups[groupId] ? <ChevronDown /> : <ChevronRight />}
                        </button>
                        <span className="font-semibold text-lg">{title}</span>
                        <span className="bg-white/20 px-2 py-0.5 rounded-full text-sm">{count} items</span>
                    </div>
                    <button className="hover:bg-white/20 rounded p-1 transition-colors">
                        <MoreHorizontal size={20} />
                    </button>
                </div>
            );

            const groups = {
                group1: { title: 'INBOX', bgColor: theme.accent },
                group2: { title: 'COMPLETED', bgColor: theme.highlight }
            };

            // Show loading screen
            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: '#1f2937' }}>
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
                            <p className="text-white text-lg">Loading...</p>
                        </div>
                    </div>
                );
            }

            // Show login screen if not authenticated
            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-6" style={{ backgroundColor: '#1f2937' }}>
                        <div className="w-full max-w-md">
                            <div className="bg-white rounded-2xl shadow-2xl p-8">
                                <div className="text-center mb-8">
                                    <div className="inline-flex items-center justify-center w-20 h-20 bg-orange-100 rounded-full mb-4">
                                        <Lock size={40} style={{ color: '#D8973C' }} />
                                    </div>
                                    <h1 className="text-3xl font-bold text-gray-900 mb-2">COMCAM Dashboard</h1>
                                    <p className="text-gray-600">Sign in to access your dashboard</p>
                                </div>

                                <form onSubmit={handleLogin} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Email
                                        </label>
                                        <input
                                            type="email"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                            placeholder="your@email.com"
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Password
                                        </label>
                                        <input
                                            type="password"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                            required
                                        />
                                    </div>

                                    {authError && (
                                        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                                            {authError}
                                        </div>
                                    )}

                                    <button
                                        type="submit"
                                        className="w-full py-3 px-4 bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-lg transition-colors"
                                    >
                                        Sign In
                                    </button>
                                </form>

                                <div className="mt-6 text-center">
                                    <p className="text-sm text-gray-600">
                                        Secure access powered by Firebase
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`min-h-screen p-4 ${resizingColumn ? 'cursor-col-resize' : ''}`} style={{ backgroundColor: theme.background }}>
                    <div className="w-full">
                        <div className="rounded-xl shadow-lg p-4 mb-4" style={{ backgroundColor: theme.cardBg || theme.background }}>
                            <div className="flex items-center justify-between">
                                <div>
                                    <div className="flex items-center gap-2 mb-1">
                                        <h1 className="text-2xl font-bold" style={{ color: theme.textPrimary }}>COMCAM Dashboard</h1>
                                        <span className="text-xs font-semibold px-2 py-1 rounded bg-gray-200 text-gray-600" style={{ opacity: 0.7 }}>v4.7</span>
                                        
                                        {/* Firebase Sync Status */}
                                        {user && (
                                            <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold ${
                                                firebaseSynced 
                                                    ? 'bg-green-100 text-green-800' 
                                                    : 'bg-yellow-100 text-yellow-800'
                                            }`}>
                                                <div className={`w-2 h-2 rounded-full ${
                                                    firebaseSynced ? 'bg-green-600' : 'bg-yellow-600 animate-pulse'
                                                }`}></div>
                                                {firebaseSynced ? 'Cloud Synced' : 'Syncing...'}
                                            </div>
                                        )}
                                        
                                        <button
                                            onClick={() => setShowDashboardTotal(!showDashboardTotal)}
                                            className="p-2 rounded-lg transition-all"
                                            style={{ 
                                                backgroundColor: settings.darkMode ? '#3a3a3a' : '#f3f4f6',
                                                color: theme.textSecondary
                                            }}
                                            title={showDashboardTotal ? "Hide Dashboard Total" : "Show Dashboard Total"}
                                        >
                                            {showDashboardTotal ? <EyeOff size={20} /> : <Eye size={20} />}
                                        </button>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setShowSettings(true)}
                                        className="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors flex items-center gap-2 text-xs"
                                    >
                                        <Settings size={14} />
                                        Settings
                                    </button>
                                    
                                    <button
                                        onClick={handleLogout}
                                        className="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2 text-xs"
                                        title="Sign out"
                                    >
                                        <User size={14} />
                                        Logout
                                    </button>
                                    
                                    <button
                                        onClick={() => {
                                            setShowNewRequests(true);
                                            fetchNewRequests();
                                        }}
                                        className={`relative px-3 py-1.5 rounded-lg font-medium transition-colors flex items-center gap-2 text-xs ${
                                            apiConnected 
                                                ? 'bg-green-600 hover:bg-green-700 text-white' 
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        }`}
                                        disabled={!apiConnected}
                                        title={apiConnected ? 'Check new requests' : 'API not connected'}
                                    >
                                        <Bell size={14} />
                                        New Requests
                                        {unreadCount > 0 && (
                                            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">
                                                {unreadCount}
                                            </span>
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="rounded-xl shadow-lg overflow-hidden" style={{ backgroundColor: theme.background }}>
                            {Object.entries(groups).map(([groupId, groupData]) => {
                                const groupTasks = tasks.filter(t => t.group === groupId);
                                
                                return (
                                    <div key={groupId} className="border-b border-gray-200 last:border-b-0">
                                        <GroupHeader 
                                            title={groupData.title} 
                                            groupId={groupId} 
                                            count={groupTasks.length}
                                            bgColor={groupData.bgColor}
                                        />
                                        
                                        {expandedGroups[groupId] && (
                                            <div className="overflow-x-auto">
                                                <table className="min-w-full" style={{ width: '100%', tableLayout: 'auto' }}>
                                                    <thead>
                                                        <tr style={{ 
                                                            backgroundColor: settings.darkMode ? '#3a3a3a' : '#f9fafb',
                                                            borderBottom: `1px solid ${settings.darkMode ? '#4a4a4a' : '#e5e7eb'}`
                                                        }}>
                                                            {columnOrder.map((columnKey) => {
                                                                const column = columns[columnKey];
                                                                const headerBg = settings.darkMode ? '#3a3a3a' : '#f9fafb';
                                                                const headerTextColor = getTextColor(headerBg);
                                                                return (
                                                                    <th
                                                                        key={columnKey}
                                                                        draggable={columnKey !== 'actions' && columnKey !== 'metrics' && columnKey !== 'drag'}
                                                                        onDragStart={(e) => handleColumnDragStart(e, columnKey)}
                                                                        onDragOver={(e) => handleColumnDragOver(e, columnKey)}
                                                                        onDragEnd={handleColumnDragEnd}
                                                                        style={{ 
                                                                            minWidth: `${columnWidths[columnKey]}px`,
                                                                            color: headerTextColor
                                                                        }}
                                                                        className={`px-4 py-3 text-left text-sm font-semibold relative ${
                                                                            columnKey !== 'actions' && columnKey !== 'metrics' && columnKey !== 'drag' ? 'cursor-move transition-colors' : 'text-center'
                                                                        } ${draggedColumn === columnKey ? 'opacity-50' : ''}`}
                                                                        onMouseEnter={(e) => {
                                                                            if (columnKey !== 'actions' && columnKey !== 'metrics') {
                                                                                e.currentTarget.style.backgroundColor = settings.darkMode ? '#4a4a4a' : '#f3f4f6';
                                                                            }
                                                                        }}
                                                                        onMouseLeave={(e) => {
                                                                            if (columnKey !== 'actions' && columnKey !== 'metrics') {
                                                                                e.currentTarget.style.backgroundColor = 'transparent';
                                                                            }
                                                                        }}
                                                                    >
                                                                        <div className="flex items-center gap-2 justify-center">
                                                                            {column.icon}
                                                                            {column.label}
                                                                        </div>
                                                                        
                                                                        {columnKey !== 'actions' && columnKey !== 'metrics' && (
                                                                            <div
                                                                                onMouseDown={(e) => handleResizeStart(e, columnKey)}
                                                                                className="absolute right-0 top-0 bottom-0 w-4 cursor-col-resize group"
                                                                                style={{ 
                                                                                    backgroundColor: resizingColumn === columnKey ? '#3b82f6' : 'transparent'
                                                                                }}
                                                                                onMouseEnter={(e) => e.currentTarget.style.backgroundColor = 'rgba(59, 130, 246, 0.5)'}
                                                                                onMouseLeave={(e) => {
                                                                                    if (resizingColumn !== columnKey) {
                                                                                        e.currentTarget.style.backgroundColor = 'transparent';
                                                                                    }
                                                                                }}
                                                                            >
                                                                                <div className="absolute right-0 top-0 bottom-0 w-1 transition-colors" style={{
                                                                                    backgroundColor: settings.darkMode ? '#6b7280' : '#d1d5db'
                                                                                }}/>
                                                                            </div>
                                                                        )}
                                                                    </th>
                                                                );
                                                            })}
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {groupTasks.map((task, index) => {
                                                            // Calculate row colors based on theme and dark mode
                                                            const evenRowBg = settings.darkMode ? '#3a3a3a' : theme.background;
                                                            const oddRowBg = settings.darkMode ? '#2e2e2e' : (theme.cardBg || theme.background);
                                                            const hoverBg = settings.darkMode ? theme.accent + '40' : theme.accent + '30';
                                                            const currentRowBg = index % 2 === 0 ? evenRowBg : oddRowBg;
                                                            const textColor = getTextColor(currentRowBg);
                                                            
                                                            // Check if this row has an expanded dropdown/calendar
                                                            const hasExpanded = expandedDropdown?.startsWith(`${task.id}-`);
                                                            
                                                            return (
                                                                <tr 
                                                                    key={task.id}
                                                                    draggable="true"
                                                                    onDragStart={(e) => handleDragStart(e, task)}
                                                                    onDragEnd={handleDragEnd}
                                                                    onDragOver={(e) => handleDragOver(e, task)}
                                                                    onDragLeave={handleDragLeave}
                                                                    onDrop={(e) => handleDrop(e, task)}
                                                                    style={{
                                                                        backgroundColor: currentRowBg,
                                                                        color: textColor,
                                                                        transition: 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)'
                                                                    }}
                                                                    onMouseEnter={(e) => !hasExpanded && (e.currentTarget.style.backgroundColor = hoverBg)}
                                                                    onMouseLeave={(e) => !hasExpanded && (e.currentTarget.style.backgroundColor = currentRowBg)}
                                                                    className={`border-b cursor-move ${
                                                                        dragOverTask?.id === task.id ? 'border-t-4 border-t-blue-500' : ''
                                                                    } ${
                                                                        draggedTask?.id === task.id ? 'opacity-50' : ''
                                                                    } ${
                                                                        settings.darkMode ? 'border-gray-700' : 'border-gray-200'
                                                                    } ${
                                                                        hasExpanded ? 'calendar-expanded' : ''
                                                                    }`}
                                                                >
                                                                {columnOrder.map((columnKey) => (
                                                                    <td 
                                                                        key={columnKey} 
                                                                        style={{ minWidth: `${columnWidths[columnKey]}px`, color: textColor }}
                                                                        className={`px-4 py-3 align-top ${(columnKey === 'actions' || columnKey === 'metrics') ? 'text-center' : ''}`}
                                                                    >
                                                                        {renderCell(columnKey, task)}
                                                                    </td>
                                                                ))}
                                                            </tr>
                                                        );
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        )}
                                        
                                        {expandedGroups[groupId] && groupId === 'group1' && (
                                            <div className="px-4 py-2">
                                                <button 
                                                    onClick={() => addTask(groupId)}
                                                    className="py-2 px-4 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors flex items-center gap-2 text-sm font-semibold shadow-md hover:shadow-lg"
                                                >
                                                    <Plus size={16} />
                                                    Add new item
                                                </button>
                                            </div>
                                        )}
                                        
                                        {groupId === 'group2' && (
                                            <div style={{ background: `linear-gradient(135deg, ${theme.secondary}15 0%, ${theme.accent}15 100%)` }} className="border-t-4 px-8 py-8" style={{ borderTopColor: theme.primary }}>
                                                {selectedTaskForMetrics ? (
                                                    // Split layout with metrics on left and dashboard total on right (when shown)
                                                    <div className={`grid gap-8 ${showDashboardTotal ? 'grid-cols-2' : 'grid-cols-1'}`}>
                                                        {/* Metrics Panel - Left Side (or Full Width when Dashboard Total is hidden) */}
                                                        <div className="rounded-xl shadow-2xl p-8" style={{ 
                                                            background: `linear-gradient(135deg, ${theme.primary}15 0%, ${theme.accent}25 100%)`,
                                                            border: `3px solid ${theme.primary}`,
                                                            backgroundColor: theme.cardBg || theme.background 
                                                        }}>
                                                            <div className="flex items-center justify-between mb-6">
                                                                <div className="flex items-center gap-3">
                                                                    <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: theme.primary }}>
                                                                        <BarChart size={24} style={{ color: '#ffffff' }} />
                                                                    </div>
                                                                    <h3 className="text-2xl font-bold" style={{ color: theme.textPrimary }}>Project Metrics</h3>
                                                                </div>
                                                                <button
                                                                    onClick={() => setSelectedTaskForMetrics(null)}
                                                                    className="p-2 rounded-lg transition-colors hover:opacity-80"
                                                                    style={{ 
                                                                        backgroundColor: settings.darkMode ? '#3a3a3a' : '#f3f4f6',
                                                                        color: theme.textSecondary 
                                                                    }}
                                                                    title="Close metrics"
                                                                >
                                                                    <X size={20} />
                                                                </button>
                                                            </div>

                                                            {/* Project Name */}
                                                            <div className="mb-6 pb-4" style={{ borderBottom: `2px solid ${theme.primary}30` }}>
                                                                <h4 className="text-xl font-semibold" style={{ color: theme.textPrimary }}>{selectedTaskForMetrics.task || 'Untitled Project'}</h4>
                                                                <p className="text-sm mt-1" style={{ color: theme.textSecondary }}>{selectedTaskForMetrics.clientName || 'No client specified'}</p>
                                                            </div>

                                                            {/* Time Metrics */}
                                                            <div className="grid grid-cols-2 gap-4 mb-6">
                                                                <div className="text-center rounded-lg p-4" style={{ 
                                                                    background: `linear-gradient(135deg, ${theme.accent}20 0%, ${theme.accent}10 100%)`,
                                                                    border: `2px solid ${theme.accent}`
                                                                }}>
                                                                    <div className="text-xs uppercase tracking-wide mb-2" style={{ color: theme.textSecondary }}>Your Actual Time</div>
                                                                    <div className="text-3xl font-bold" style={{ color: theme.accent }}>
                                                                        {selectedTaskForMetrics.actualWorkHours || 0}hrs
                                                                    </div>
                                                                </div>
                                                                <div className="text-center rounded-lg p-4" style={{ 
                                                                    background: `linear-gradient(135deg, ${theme.highlight}20 0%, ${theme.highlight}10 100%)`,
                                                                    border: `2px solid ${theme.highlight}`
                                                                }}>
                                                                    <div className="text-xs uppercase tracking-wide mb-2" style={{ color: theme.textSecondary }}>Invoice Hours</div>
                                                                    <div className="text-3xl font-bold" style={{ color: theme.highlight }}>
                                                                        {selectedTaskForMetrics.workHours || 0}hrs
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            {/* Rate Metrics */}
                                                            <div className="grid grid-cols-2 gap-4 mb-6">
                                                                <div className="text-center rounded-lg p-4" style={{ 
                                                                    background: `linear-gradient(135deg, ${theme.accent}20 0%, ${theme.accent}10 100%)`,
                                                                    border: `2px solid ${theme.accent}`
                                                                }}>
                                                                    <div className="text-xs uppercase tracking-wide mb-2" style={{ color: theme.textSecondary }}>Effective Rate</div>
                                                                    <div className="text-3xl font-bold" style={{ color: theme.accent }}>
                                                                        ${(() => {
                                                                            const actualHours = parseFloat(selectedTaskForMetrics.actualWorkHours) || 0;
                                                                            const totalPrice = parseFloat(selectedTaskForMetrics.totalPrice) || 0;
                                                                            return actualHours > 0 ? Math.round(totalPrice / actualHours) : 0;
                                                                        })()}/hr
                                                                    </div>
                                                                </div>
                                                                <div className="text-center rounded-lg p-4" style={{ 
                                                                    background: `linear-gradient(135deg, ${theme.highlight}20 0%, ${theme.highlight}10 100%)`,
                                                                    border: `2px solid ${theme.highlight}`
                                                                }}>
                                                                    <div className="text-xs uppercase tracking-wide mb-2" style={{ color: theme.textSecondary }}>Invoice Rate</div>
                                                                    <div className="text-3xl font-bold" style={{ color: theme.highlight }}>
                                                                        ${(() => {
                                                                            const invoiceHours = parseFloat(selectedTaskForMetrics.workHours) || 0;
                                                                            const totalPrice = parseFloat(selectedTaskForMetrics.totalPrice) || 0;
                                                                            // Calculate rate from total price / invoice hours, default to $65 if not set
                                                                            return invoiceHours > 0 ? Math.round(totalPrice / invoiceHours) : 65;
                                                                        })()}/hr
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            {/* Deadline Information */}
                                                            <div className="rounded-lg p-4 mb-4" style={{ 
                                                                background: `linear-gradient(135deg, ${theme.secondary}40 0%, ${theme.secondary}20 100%)`,
                                                                border: `2px solid ${theme.secondary}`
                                                            }}>
                                                                <div className="flex items-center gap-2 mb-2">
                                                                    <div className="text-xl">â±ï¸</div>
                                                                    <div className="text-sm font-semibold uppercase tracking-wide" style={{ color: theme.dark }}>Your Deadline (Internal)</div>
                                                                </div>
                                                                <div className="text-4xl font-bold" style={{ color: theme.dark }}>
                                                                    {(() => {
                                                                        const actualHours = parseFloat(selectedTaskForMetrics.actualWorkHours) || 0;
                                                                        const invoiceHours = parseFloat(selectedTaskForMetrics.workHours) || 0;
                                                                        const bufferDays = invoiceHours - actualHours > 0 ? Math.round((invoiceHours - actualHours) / 8) : 0;
                                                                        return `Day ${Math.max(1, Math.ceil(actualHours / 8))}`;
                                                                    })()}
                                                                </div>
                                                            </div>

                                                            {/* Client Quoted Due Date */}
                                                            <div className="rounded-lg p-4 mb-4" style={{ 
                                                                background: `linear-gradient(135deg, ${theme.accent}30 0%, ${theme.accent}15 100%)`,
                                                                border: `2px solid ${theme.accent}`
                                                            }}>
                                                                <div className="text-xs uppercase tracking-wide mb-2 text-center font-semibold" style={{ color: theme.accent }}>Client Quoted Due Date (Calendar Days)</div>
                                                                <div className="text-4xl font-bold text-center" style={{ color: theme.accent }}>
                                                                    {(() => {
                                                                        // Use manual timeline if set, otherwise calculate based on work hours
                                                                        if (selectedTaskForMetrics.timeline) {
                                                                            return selectedTaskForMetrics.timeline;
                                                                        }
                                                                        const actualHours = parseFloat(selectedTaskForMetrics.actualWorkHours) || 0;
                                                                        // Calculate: your work days Ã— 2.5 (industry standard buffer)
                                                                        // Minimum 3 calendar days for any project
                                                                        const calculatedDays = Math.max(3, Math.ceil((actualHours / 8) * 2.5));
                                                                        return calculatedDays;
                                                                    })()} Calendar Days
                                                                </div>
                                                            </div>

                                                            {/* Strategy Tip */}
                                                            <div className="rounded-lg p-4" style={{ 
                                                                background: `linear-gradient(135deg, ${theme.highlight}25 0%, ${theme.highlight}10 100%)`,
                                                                border: `2px solid ${theme.highlight}`
                                                            }}>
                                                                <div className="flex items-start gap-2">
                                                                    <div className="text-xl flex-shrink-0">âœ…</div>
                                                                    <div>
                                                                        <p className="text-sm" style={{ color: theme.textPrimary }}>
                                                                            <strong>Your Advantage:</strong> Your work will be completed by Day {Math.max(1, Math.ceil((parseFloat(selectedTaskForMetrics.actualWorkHours) || 0) / 8))} ({(parseFloat(selectedTaskForMetrics.actualWorkHours) || 0)}hrs actual time). 
                                                                            <strong className="block mt-1">**STRATEGY:**</strong> Tell the client the due date is in {(() => {
                                                                                if (selectedTaskForMetrics.timeline) {
                                                                                    return selectedTaskForMetrics.timeline;
                                                                                }
                                                                                const actualHours = parseFloat(selectedTaskForMetrics.actualWorkHours) || 0;
                                                                                return Math.max(3, Math.ceil((actualHours / 8) * 2.5));
                                                                            })()} calendar days, giving you a {(() => {
                                                                                const actualHours = parseFloat(selectedTaskForMetrics.actualWorkHours) || 0;
                                                                                const actualWorkDays = Math.ceil(actualHours / 8);
                                                                                // Calculate client timeline (use manual or auto-calculated)
                                                                                const clientTimeline = selectedTaskForMetrics.timeline || Math.max(3, Math.ceil((actualHours / 8) * 2.5));
                                                                                // Real buffer = client timeline - your actual work days
                                                                                const realBuffer = clientTimeline - actualWorkDays;
                                                                                return Math.max(0, realBuffer);
                                                                            })()} day cushion for revisions, unexpected delays, or getting ahead on other projects.
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Dashboard Total - Right Side (Smaller Square) */}
                                                        {showDashboardTotal && (
                                                            <div>
                                                                <div className="rounded-xl shadow-2xl p-8" style={{ 
                                                                    background: `linear-gradient(135deg, ${theme.primary}15 0%, ${theme.secondary}25 100%)`,
                                                                    border: `3px solid ${theme.primary}`,
                                                                    backgroundColor: theme.cardBg || theme.background 
                                                                }}>
                                                                    <div className="mb-6">
                                                                        <div className="flex items-center gap-3 mb-2">
                                                                            <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: theme.primary }}>
                                                                                <span className="text-2xl text-white">ðŸ’°</span>
                                                                            </div>
                                                                            <h3 className="text-2xl font-bold" style={{ color: theme.textPrimary }}>Dashboard Total</h3>
                                                                        </div>
                                                                        <p className="text-sm ml-13" style={{ color: theme.textSecondary }}>Sum of all project prices</p>
                                                                    </div>
                                                                    <div className="text-center mb-6 p-6 rounded-xl" style={{ 
                                                                        background: `linear-gradient(135deg, ${theme.primary}20 0%, ${theme.primary}05 100%)`,
                                                                        border: `2px solid ${theme.primary}`
                                                                    }}>
                                                                        <div className="font-bold" style={{ color: theme.primary, fontFamily: 'Kanit, sans-serif', fontSize: '6rem', lineHeight: '1' }}>
                                                                            ${tasks.reduce((sum, task) => {
                                                                                const price = parseFloat(task.totalPrice) || 0;
                                                                                return sum + price;
                                                                            }, 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                                        </div>
                                                                        <div className="text-sm mt-3 font-medium" style={{ color: theme.textSecondary }}>
                                                                            {tasks.length} total {tasks.length === 1 ? 'project' : 'projects'}
                                                                        </div>
                                                                    </div>

                                                                    <div className="space-y-4">
                                                                        <div className="rounded-lg p-5" style={{ 
                                                                            background: `linear-gradient(135deg, ${theme.accent}25 0%, ${theme.accent}10 100%)`,
                                                                            border: `2px solid ${theme.accent}`
                                                                        }}>
                                                                            <div className="text-xs uppercase tracking-wide mb-1 font-semibold" style={{ color: theme.accent }}>Inbox Total</div>
                                                                            <div className="text-3xl font-bold mb-1" style={{ color: theme.accent }}>
                                                                                ${tasks.filter(t => t.group === 'group1').reduce((sum, task) => {
                                                                                    const price = parseFloat(task.totalPrice) || 0;
                                                                                    return sum + price;
                                                                                }, 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                                            </div>
                                                                            <div className="text-xs font-medium" style={{ color: theme.textSecondary }}>
                                                                                {tasks.filter(t => t.group === 'group1').length} {tasks.filter(t => t.group === 'group1').length === 1 ? 'project' : 'projects'}
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        <div className="rounded-lg p-5" style={{ 
                                                                            background: `linear-gradient(135deg, ${theme.highlight}25 0%, ${theme.highlight}10 100%)`,
                                                                            border: `2px solid ${theme.highlight}`
                                                                        }}>
                                                                            <div className="text-xs uppercase tracking-wide mb-1 font-semibold" style={{ color: theme.highlight }}>Completed Total</div>
                                                                            <div className="text-3xl font-bold mb-1" style={{ color: theme.highlight }}>
                                                                                ${tasks.filter(t => t.group === 'group2').reduce((sum, task) => {
                                                                                    const price = parseFloat(task.totalPrice) || 0;
                                                                                    return sum + price;
                                                                                }, 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                                            </div>
                                                                            <div className="text-xs font-medium" style={{ color: theme.textSecondary }}>
                                                                                {tasks.filter(t => t.group === 'group2').length} {tasks.filter(t => t.group === 'group2').length === 1 ? 'project' : 'projects'}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : (
                                                    // Original full-width layout when no metrics selected
                                                    showDashboardTotal && (
                                                        <>
                                                            <div className="flex items-center justify-between mb-6 p-8 rounded-xl" style={{ 
                                                                background: `linear-gradient(135deg, ${theme.primary}15 0%, ${theme.secondary}25 100%)`,
                                                                border: `3px solid ${theme.primary}`
                                                            }}>
                                                                <div>
                                                                    <div className="flex items-center gap-3 mb-2">
                                                                        <div className="w-12 h-12 rounded-lg flex items-center justify-center" style={{ backgroundColor: theme.primary }}>
                                                                            <span className="text-3xl text-white">ðŸ’°</span>
                                                                        </div>
                                                                        <h3 className="text-3xl font-bold" style={{ color: theme.textPrimary }}>Dashboard Total</h3>
                                                                    </div>
                                                                    <p className="text-base ml-15" style={{ color: theme.textSecondary }}>Sum of all project prices</p>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="font-bold" style={{ color: theme.primary, fontFamily: 'Kanit, sans-serif', fontSize: '8rem', lineHeight: '1' }}>
                                                                        ${tasks.reduce((sum, task) => {
                                                                            const price = parseFloat(task.totalPrice) || 0;
                                                                            return sum + price;
                                                                        }, 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                                    </div>
                                                                    <div className="text-sm font-medium mt-2" style={{ color: theme.textSecondary }}>
                                                                        {tasks.length} total {tasks.length === 1 ? 'project' : 'projects'}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="mt-6 grid grid-cols-2 gap-6">
                                                                <div className="rounded-xl p-8 shadow-2xl" style={{ 
                                                                    background: `linear-gradient(135deg, ${theme.accent}25 0%, ${theme.accent}10 100%)`,
                                                                    border: `3px solid ${theme.accent}`
                                                                }}>
                                                                    <div className="text-sm uppercase tracking-wide mb-3 font-semibold" style={{ color: theme.accent }}>Inbox Total</div>
                                                                    <div className="text-5xl font-bold mb-2" style={{ color: theme.accent }}>
                                                                        ${tasks.filter(t => t.group === 'group1').reduce((sum, task) => {
                                                                            const price = parseFloat(task.totalPrice) || 0;
                                                                            return sum + price;
                                                                        }, 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                                    </div>
                                                                    <div className="text-sm font-medium" style={{ color: theme.textSecondary }}>
                                                                        {tasks.filter(t => t.group === 'group1').length} {tasks.filter(t => t.group === 'group1').length === 1 ? 'project' : 'projects'}
                                                                    </div>
                                                                </div>
                                                                
                                                                <div className="rounded-xl p-8 shadow-2xl" style={{ 
                                                                    background: `linear-gradient(135deg, ${theme.highlight}25 0%, ${theme.highlight}10 100%)`,
                                                                    border: `3px solid ${theme.highlight}`
                                                                }}>
                                                                    <div className="text-sm uppercase tracking-wide mb-3 font-semibold" style={{ color: theme.highlight }}>Completed Total</div>
                                                                    <div className="text-5xl font-bold mb-2" style={{ color: theme.highlight }}>
                                                                        ${tasks.filter(t => t.group === 'group2').reduce((sum, task) => {
                                                                            const price = parseFloat(task.totalPrice) || 0;
                                                                            return sum + price;
                                                                        }, 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                                    </div>
                                                                    <div className="text-sm font-medium" style={{ color: theme.textSecondary }}>
                                                                        {tasks.filter(t => t.group === 'group2').length} {tasks.filter(t => t.group === 'group2').length === 1 ? 'project' : 'projects'}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </>
                                                    )
                                                )}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>

                        {deleteConfirm && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                                    <div className="flex items-start gap-4">
                                        <div className="flex-shrink-0 w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                                            <Trash2 size={24} />
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="text-lg font-semibold text-gray-900 mb-2">Delete Task?</h3>
                                            <p className="text-gray-600 mb-1">
                                                Are you sure you want to delete this task?
                                            </p>
                                            <p className="text-sm font-medium text-gray-800 bg-gray-50 p-2 rounded mt-2">
                                                "{deleteConfirm.task}"
                                            </p>
                                            <p className="text-sm text-gray-500 mt-2">
                                                This action cannot be undone.
                                            </p>
                                        </div>
                                    </div>
                                    <div className="flex gap-3 mt-6 justify-end">
                                        <button
                                            onClick={() => setDeleteConfirm(null)}
                                            className="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={() => deleteTask(deleteConfirm.id)}
                                            className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors"
                                        >
                                            Delete Task
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showSettings && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-lg shadow-xl p-6 max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                                    <div className="flex items-center justify-between mb-6">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                                                <Settings size={20} />
                                            </div>
                                            <h3 className="text-xl font-semibold text-gray-900">Settings</h3>
                                        </div>
                                        <button
                                            onClick={() => setShowSettings(false)}
                                            className="text-gray-400 hover:text-gray-600 transition-colors"
                                        >
                                            <X size={24} />
                                        </button>
                                    </div>
                                    
                                    {/* Two Column Layout */}
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        {/* Left Column - Settings Toggles */}
                                        <div className="space-y-4">
                                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                <div>
                                                    <h4 className="font-semibold text-gray-900 mb-1">Due Date Warnings</h4>
                                                    <p className="text-sm text-gray-600">Highlight priority when tasks are due within 24 hours</p>
                                                </div>
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={settings.dueDateWarning}
                                                        onChange={(e) => setSettings({ ...settings, dueDateWarning: e.target.checked })}
                                                        className="sr-only peer"
                                                    />
                                                    <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                                </label>
                                            </div>
                                            
                                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                <div>
                                                    <h4 className="font-semibold text-gray-900 mb-1">Auto-Refresh Requests</h4>
                                                    <p className="text-sm text-gray-600">Automatically check for new requests every 60 seconds</p>
                                                </div>
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={settings.autoRefresh}
                                                        onChange={(e) => setSettings({ ...settings, autoRefresh: e.target.checked })}
                                                        className="sr-only peer"
                                                    />
                                                    <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                                </label>
                                            </div>
                                            
                                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                <div>
                                                    <h4 className="font-semibold text-gray-900 mb-1">Use Themes</h4>
                                                    <p className="text-sm text-gray-600">Enable color themes for your dashboard</p>
                                                </div>
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={settings.useTheme}
                                                        onChange={(e) => setSettings({ ...settings, useTheme: e.target.checked })}
                                                        className="sr-only peer"
                                                    />
                                                    <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                                </label>
                                            </div>
                                            
                                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                <div>
                                                    <h4 className="font-semibold text-gray-900 mb-1">ðŸŒ™ Dark Mode</h4>
                                                    <p className="text-sm text-gray-600">Enable dark mode (works with any theme)</p>
                                                </div>
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={settings.darkMode}
                                                        onChange={(e) => setSettings({ ...settings, darkMode: e.target.checked })}
                                                        className="sr-only peer"
                                                    />
                                                    <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                                </label>
                                            </div>
                                            
                                            {settings.useTheme && (
                                                <div className="p-4 bg-gray-50 rounded-lg">
                                                    <div className="mb-3">
                                                        <h4 className="font-semibold text-gray-900 mb-1">Color Theme</h4>
                                                        <p className="text-sm text-gray-600">Choose your dashboard color palette</p>
                                                    </div>
                                                    <div className="space-y-2 max-h-64 overflow-y-auto">
                                                        {Object.keys(colorThemes).filter(name => name !== 'None').map(themeName => {
                                                            const themeColors = colorThemes[themeName];
                                                            const isCustom = customThemeNames.includes(themeName);
                                                            return (
                                                                <div key={themeName} className="relative">
                                                                    <button
                                                                        onClick={() => setSettings({ ...settings, colorTheme: themeName })}
                                                                        className={`w-full flex items-center justify-between p-3 rounded-lg border-2 transition-all ${
                                                                            settings.colorTheme === themeName 
                                                                                ? 'border-blue-500 bg-blue-50' 
                                                                                : 'border-gray-200 hover:border-gray-300 bg-white'
                                                                        }`}
                                                                    >
                                                                        <div className="flex items-center gap-3">
                                                                            <div className="flex gap-1">
                                                                                <div className="w-6 h-6 rounded" style={{ backgroundColor: themeColors.primary }}></div>
                                                                                <div className="w-6 h-6 rounded" style={{ backgroundColor: themeColors.secondary }}></div>
                                                                                <div className="w-6 h-6 rounded" style={{ backgroundColor: themeColors.accent }}></div>
                                                                                <div className="w-6 h-6 rounded" style={{ backgroundColor: themeColors.highlight }}></div>
                                                                                <div className="w-6 h-6 rounded" style={{ backgroundColor: themeColors.dark }}></div>
                                                                            </div>
                                                                            <span className="font-medium text-gray-900">{themeName}</span>
                                                                            {isCustom && (
                                                                                <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full font-semibold">Custom</span>
                                                                            )}
                                                                        </div>
                                                                        <div className="flex items-center gap-2">
                                                                            {settings.colorTheme === themeName && (
                                                                                <div className="text-blue-600 font-bold">âœ“</div>
                                                                            )}
                                                                            {isCustom && (
                                                                                <button
                                                                                    onClick={(e) => {
                                                                                        e.stopPropagation();
                                                                                        if (confirm(`Delete custom theme "${themeName}"?`)) {
                                                                                            // Remove from colorThemes
                                                                                            delete colorThemes[themeName];
                                                                                            // Remove from custom theme names
                                                                                            setCustomThemeNames(prev => prev.filter(n => n !== themeName));
                                                                                            // If this was the active theme, switch to default
                                                                                            if (settings.colorTheme === themeName) {
                                                                                                setSettings({ ...settings, colorTheme: 'Cherry Blossom' });
                                                                                            }
                                                                                            alert(`ðŸ—‘ï¸ Theme "${themeName}" deleted!`);
                                                                                        }
                                                                                    }}
                                                                                    className="p-1.5 hover:bg-red-100 rounded transition-colors text-red-600"
                                                                                    title="Delete this theme"
                                                                                >
                                                                                    <Trash2 size={16} />
                                                                                </button>
                                                                            )}
                                                                        </div>
                                                                    </button>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                    
                                                    {/* Custom Theme Creator Button */}
                                                    <button
                                                        onClick={() => setShowCustomThemeCreator(!showCustomThemeCreator)}
                                                        className="w-full mt-3 py-2 px-4 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-lg font-medium transition-all flex items-center justify-center gap-2"
                                                    >
                                                        <Plus size={18} />
                                                        {showCustomThemeCreator ? 'Hide Theme Creator' : 'Create Custom Theme'}
                                                    </button>
                                                    
                                                    {/* Custom Theme Creator Form */}
                                                    {showCustomThemeCreator && (
                                                        <div className="mt-4 p-4 bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg border-2 border-purple-300">
                                                            <h5 className="font-bold text-gray-900 mb-3 flex items-center gap-2">
                                                                <span className="text-xl">ðŸŽ¨</span>
                                                                Custom Theme Creator
                                                            </h5>
                                                            <div className="space-y-3">
                                                                <div>
                                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Theme Name</label>
                                                                    <input
                                                                        type="text"
                                                                        value={customTheme.name}
                                                                        onChange={(e) => setCustomTheme({ ...customTheme, name: e.target.value })}
                                                                        placeholder="My Awesome Theme"
                                                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                                    />
                                                                </div>
                                                                <div className="grid grid-cols-2 gap-3">
                                                                    <div>
                                                                        <label className="block text-sm font-medium text-gray-700 mb-1">Background</label>
                                                                        <input
                                                                            type="color"
                                                                            value={customTheme.background}
                                                                            onChange={(e) => setCustomTheme({ ...customTheme, background: e.target.value })}
                                                                            className="w-full h-10 rounded border border-gray-300 cursor-pointer"
                                                                        />
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-sm font-medium text-gray-700 mb-1">Card Background</label>
                                                                        <input
                                                                            type="color"
                                                                            value={customTheme.cardBg}
                                                                            onChange={(e) => setCustomTheme({ ...customTheme, cardBg: e.target.value })}
                                                                            className="w-full h-10 rounded border border-gray-300 cursor-pointer"
                                                                        />
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-sm font-medium text-gray-700 mb-1">Primary</label>
                                                                        <input
                                                                            type="color"
                                                                            value={customTheme.primary}
                                                                            onChange={(e) => setCustomTheme({ ...customTheme, primary: e.target.value })}
                                                                            className="w-full h-10 rounded border border-gray-300 cursor-pointer"
                                                                        />
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-sm font-medium text-gray-700 mb-1">Secondary</label>
                                                                        <input
                                                                            type="color"
                                                                            value={customTheme.secondary}
                                                                            onChange={(e) => setCustomTheme({ ...customTheme, secondary: e.target.value })}
                                                                            className="w-full h-10 rounded border border-gray-300 cursor-pointer"
                                                                        />
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-sm font-medium text-gray-700 mb-1">Accent (INBOX)</label>
                                                                        <input
                                                                            type="color"
                                                                            value={customTheme.accent}
                                                                            onChange={(e) => setCustomTheme({ ...customTheme, accent: e.target.value })}
                                                                            className="w-full h-10 rounded border border-gray-300 cursor-pointer"
                                                                        />
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-sm font-medium text-gray-700 mb-1">Highlight (COMPLETED)</label>
                                                                        <input
                                                                            type="color"
                                                                            value={customTheme.highlight}
                                                                            onChange={(e) => setCustomTheme({ ...customTheme, highlight: e.target.value })}
                                                                            className="w-full h-10 rounded border border-gray-300 cursor-pointer"
                                                                        />
                                                                    </div>
                                                                </div>
                                                                <button
                                                                    onClick={() => {
                                                                        if (!customTheme.name.trim()) {
                                                                            alert('Please enter a theme name!');
                                                                            return;
                                                                        }
                                                                        // Check if theme name already exists
                                                                        if (colorThemes[customTheme.name]) {
                                                                            alert('âš ï¸ A theme with this name already exists! Please choose a different name.');
                                                                            return;
                                                                        }
                                                                        // Add the custom theme to colorThemes
                                                                        colorThemes[customTheme.name] = { ...customTheme };
                                                                        // Add to custom theme names list
                                                                        setCustomThemeNames(prev => [...prev, customTheme.name]);
                                                                        // Set it as the active theme
                                                                        setSettings({ ...settings, colorTheme: customTheme.name });
                                                                        // Store the theme name for later reference
                                                                        const themeName = customTheme.name;
                                                                        // Reset the form
                                                                        setCustomTheme({
                                                                            name: '',
                                                                            background: '#ffffff',
                                                                            cardBg: '#ffffff',
                                                                            primary: '#3b82f6',
                                                                            secondary: '#8b5cf6',
                                                                            accent: '#10b981',
                                                                            highlight: '#f59e0b',
                                                                            dark: '#1f2937',
                                                                            textPrimary: '#1f2937',
                                                                            textSecondary: '#6b7280'
                                                                        });
                                                                        setShowCustomThemeCreator(false);
                                                                        alert(`ðŸŽ¨ Theme "${themeName}" created and activated!`);
                                                                    }}
                                                                    className="w-full py-2 px-4 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white rounded-lg font-bold transition-all"
                                                                >
                                                                    âœ¨ Create & Apply Theme
                                                                </button>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* Right Column - Reports & Data Management */}
                                        <div className="space-y-6">
                                            {/* Reports Generator Section */}
                                            <div className="p-4 bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg border-2 border-purple-200">
                                                <div className="mb-4">
                                                    <h4 className="font-bold text-gray-900 mb-1 flex items-center gap-2">
                                                        <span className="text-xl">ðŸ“Š</span>
                                                        Reports Generator
                                                    </h4>
                                                    <p className="text-sm text-gray-600">Export data as CSV files for Excel, Google Sheets, or data analysis</p>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button
                                                        onClick={() => generateCSVReport('thisMonth')}
                                                        className="px-3 py-2 bg-white hover:bg-purple-50 text-gray-700 border border-purple-300 rounded-lg text-sm font-medium transition-colors"
                                                    >
                                                        This Month
                                                    </button>
                                                    <button
                                                        onClick={() => generateCSVReport('lastMonth')}
                                                        className="px-3 py-2 bg-white hover:bg-purple-50 text-gray-700 border border-purple-300 rounded-lg text-sm font-medium transition-colors"
                                                    >
                                                        Last Month
                                                    </button>
                                                    <button
                                                        onClick={() => generateCSVReport('thisQuarter')}
                                                        className="px-3 py-2 bg-white hover:bg-purple-50 text-gray-700 border border-purple-300 rounded-lg text-sm font-medium transition-colors"
                                                    >
                                                        This Quarter
                                                    </button>
                                                    <button
                                                        onClick={() => generateCSVReport('lastQuarter')}
                                                        className="px-3 py-2 bg-white hover:bg-purple-50 text-gray-700 border border-purple-300 rounded-lg text-sm font-medium transition-colors"
                                                    >
                                                        Last Quarter
                                                    </button>
                                                    <button
                                                        onClick={() => generateCSVReport('thisYear')}
                                                        className="px-3 py-2 bg-white hover:bg-purple-50 text-gray-700 border border-purple-300 rounded-lg text-sm font-medium transition-colors"
                                                    >
                                                        This Year
                                                    </button>
                                                    <button
                                                        onClick={() => generateCSVReport('lastYear')}
                                                        className="px-3 py-2 bg-white hover:bg-purple-50 text-gray-700 border border-purple-300 rounded-lg text-sm font-medium transition-colors"
                                                    >
                                                        Last Year
                                                    </button>
                                                    <button
                                                        onClick={() => generateCSVReport('allTime')}
                                                        className="col-span-2 px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-bold transition-colors"
                                                    >
                                                        ðŸ“ˆ All Time Report
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            {/* Data Management Section */}
                                            <div className="p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg border-2 border-blue-200">
                                                <div className="mb-4">
                                                    <h4 className="font-bold text-gray-900 mb-1 flex items-center gap-2">
                                                        <span className="text-xl">ðŸ’¾</span>
                                                        Data Management
                                                    </h4>
                                                    <p className="text-sm text-gray-600">Backup and restore your dashboard data</p>
                                                </div>
                                                <div className="space-y-2">
                                                    <button
                                                        onClick={saveBackupForDrive}
                                                        className="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
                                                    >
                                                        <Save size={16} />
                                                        Download Backup File
                                                    </button>
                                                    <label htmlFor="fileInputSettings" className="cursor-pointer w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                                                        <Upload size={16} />
                                                        Load Data from File
                                                    </label>
                                                    <input
                                                        id="fileInputSettings"
                                                        type="file"
                                                        accept=".json"
                                                        onChange={handleFileLoad}
                                                        className="hidden"
                                                    />
                                                </div>
                                                <div className="mt-3 p-2 bg-blue-100 rounded text-xs text-blue-800">
                                                    â„¹ï¸ Your data syncs automatically to Firebase. Backups are for archiving or migration.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="flex justify-between items-center mt-6 pt-4 border-t">
                                        <div className="text-xs text-gray-500">
                                            â˜ï¸ All changes sync automatically to Firebase
                                        </div>
                                        <button
                                            onClick={() => setShowSettings(false)}
                                            className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
                                        >
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {showNewRequests && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white rounded-lg shadow-xl p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
                                    <div className="flex items-center justify-between mb-6">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                                                <Bell size={20} />
                                            </div>
                                            <div>
                                                <h3 className="text-xl font-semibold text-gray-900">New Requests</h3>
                                                <p className="text-sm text-gray-600">
                                                    {apiConnected ? `${unreadCount} unread request${unreadCount !== 1 ? 's' : ''}` : 'API not connected'}
                                                </p>
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={fetchNewRequests}
                                                className="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                                                title="Refresh"
                                                disabled={isLoadingRequests}
                                            >
                                                <RefreshCw size={20} className={isLoadingRequests ? 'animate-spin' : ''} />
                                            </button>
                                            <button
                                                onClick={() => setShowNewRequests(false)}
                                                className="text-gray-400 hover:text-gray-600 transition-colors"
                                            >
                                                <X size={24} />
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="flex-1 overflow-y-auto">
                                        {!apiConnected ? (
                                            <div className="text-center py-12">
                                                <div className="text-6xl mb-4">âš ï¸</div>
                                                <h4 className="text-lg font-semibold text-gray-900 mb-2">Firebase Not Connected</h4>
                                                <p className="text-gray-600 mb-4">Check your internet connection and Firebase configuration</p>
                                                <code className="bg-gray-100 px-3 py-1 rounded text-sm block mb-2">{firebaseConfig.databaseURL}</code>
                                                <p className="text-sm text-gray-500 mb-4">Make sure your Firebase Realtime Database rules allow read access</p>
                                                <div className="mt-6">
                                                    <button
                                                        onClick={checkApiConnection}
                                                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
                                                    >
                                                        Retry Connection
                                                    </button>
                                                </div>
                                            </div>
                                        ) : newRequests.length === 0 ? (
                                            <div className="text-center py-12">
                                                <div className="text-6xl mb-4">ðŸ“­</div>
                                                <h4 className="text-lg font-semibold text-gray-900 mb-2">No New Requests</h4>
                                                <p className="text-gray-600">All caught up! Check back later.</p>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                {newRequests.map(request => (
                                                    <div key={request.id} className="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
                                                        <div className="flex items-start justify-between mb-3">
                                                            <div className="flex-1">
                                                                <h4 className="font-semibold text-gray-900 mb-1">
                                                                    {request.task || request.projectName || 'Untitled Project'}
                                                                </h4>
                                                                <div className="flex items-center gap-4 text-sm text-gray-600">
                                                                    <span className="flex items-center gap-1">
                                                                        <User size={14} />
                                                                        {request.clientName || 'Unknown Client'}
                                                                    </span>
                                                                    <span className="flex items-center gap-1">
                                                                        <Calendar size={14} />
                                                                        {request.requestDate || new Date(request.submittedAt).toISOString().split('T')[0]}
                                                                    </span>
                                                                    {request.totalPrice && (
                                                                        <span className="font-semibold text-green-600">
                                                                            ${parseFloat(request.totalPrice).toLocaleString()}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button
                                                                    onClick={async () => {
                                                                        await importRequest(request);
                                                                        if (newRequests.length === 1) {
                                                                            setShowNewRequests(false);
                                                                        }
                                                                    }}
                                                                    className="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-1"
                                                                >
                                                                    <Download size={14} />
                                                                    Import
                                                                </button>
                                                                <button
                                                                    onClick={() => dismissRequest(request.id)}
                                                                    className="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded text-sm font-medium transition-colors"
                                                                >
                                                                    Dismiss
                                                                </button>
                                                            </div>
                                                        </div>
                                                        {(request.notes || request.projectDescription) && (
                                                            <div className="text-sm text-gray-600 bg-gray-50 p-2 rounded mt-2">
                                                                {request.notes || request.projectDescription}
                                                            </div>
                                                        )}
                                                        <div className="mt-2 flex gap-2 flex-wrap text-xs">
                                                            {request.priority && (
                                                                <span className={`px-2 py-1 rounded ${
                                                                    request.priority === 'High' 
                                                                        ? 'bg-yellow-100 text-yellow-800' 
                                                                        : 'bg-blue-100 text-blue-800'
                                                                }`}>
                                                                    {request.priority} Priority
                                                                </span>
                                                            )}
                                                            {request.timeline && (
                                                                <span className="px-2 py-1 rounded bg-purple-100 text-purple-800">
                                                                    {request.timeline} timeline
                                                                </span>
                                                            )}
                                                            {request.invoiceNumber && (
                                                                <span className="px-2 py-1 rounded bg-green-100 text-green-800">
                                                                    {request.invoiceNumber}
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="flex justify-end mt-6 pt-4 border-t">
                                        <button
                                            onClick={() => setShowNewRequests(false)}
                                            className="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-colors"
                                        >
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
